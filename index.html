<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심화 탐구 통합 워크북</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
        * { box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f1f5f9; color: #1e293b; margin: 0; padding: 0; word-break: keep-all; }
        .serif { font-family: 'Noto Serif KR', serif; }
        .paper-texture { background-image: url("https://www.transparenttextures.com/patterns/paper-fibers.png"); }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } .page { padding: 20mm !important; page-break-after: always; } }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 선생님의 구글 앱스 스크립트 주소
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwozNNnGBT-iJtUzLAlalEJdEn_oEDMt3IIqNBwMHPuEQhmwvUi_x1-AbXDJoydCKcX/exec";

        const App = () => {
            const [personalCode, setPersonalCode] = useState("");
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [studentInfo, setStudentInfo] = useState({ school: "공주여자고등학교", gradeClass: "", name: "", major: "" });
            const [sessionData, setSessionData] = useState({
                s1_motive: "", s1_question: "", s2_book: "", s5_log: "", s8_summary: ""
            });
            const [activeTab, setActiveTab] = useState(0);

            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            }, [activeTab, isLoggedIn]);

            // 서버에서 데이터 불러오기
            const handleLogin = async (e) => {
                e.preventDefault();
                if (personalCode.trim().length < 2) return alert("코드를 입력해 주세요.");
                setIsLoading(true);
                try {
                    const res = await fetch(`${SCRIPT_URL}?userKey=${encodeURIComponent(personalCode)}`);
                    const json = await res.json();
                    
                    if (json && json.name) {
                        setStudentInfo({
                            school: json.school || "공주여자고등학교",
                            gradeClass: json.gradeClass || "",
                            name: json.name || "",
                            major: json.major || ""
                        });
                        setSessionData({
                            s1_motive: json.s1_motive || "",
                            s1_question: json.s1_question || "",
                            s2_book: json.s2_book || "",
                            s5_log: json.s5_log || "",
                            s8_summary: json.s8_summary || ""
                        });
                    }
                    setIsLoggedIn(true);
                } catch (err) {
                    // 데이터가 없는 경우 신규 작성으로 진입
                    setIsLoggedIn(true);
                }
                setIsLoading(false);
            };

            // 서버에 데이터 저장하기
            const saveData = async () => {
                setIsLoading(true);
                const payload = { 
                    userKey: personalCode, 
                    ...studentInfo, 
                    ...sessionData 
                };
                try {
                    await fetch(SCRIPT_URL, { 
                        method: 'POST', 
                        body: JSON.stringify(payload) 
                    });
                    alert("구글 스프레드시트에 실시간 저장되었습니다.");
                } catch (err) { 
                    alert("저장에 실패했습니다. 인터넷 연결을 확인하세요."); 
                }
                setIsLoading(false);
            };

            const tabs = [
                { id: 0, title: "기본 정보", icon: "user", key: null },
                { id: 1, title: "탐구 질문", icon: "help-circle", key: "s1_motive" },
                { id: 2, title: "도서/분석", icon: "book", key: "s2_book" },
                { id: 5, title: "수행 기록", icon: "pen-tool", key: "s5_log" },
                { id: 8, title: "최종 성찰", icon: "award", key: "s8_summary" }
            ];

            if (!isLoggedIn) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 paper-texture p-6 text-center">
                    <div className="max-w-md w-full bg-white rounded-[40px] shadow-2xl p-10 border-t-[12px] border-indigo-600">
                        <h1 className="serif text-3xl font-black mb-2 text-slate-800">탐구 워크북 시스템</h1>
                        <p className="text-slate-400 text-sm mb-10 font-medium">나만의 고유 코드를 입력하여 탐구를 시작하세요.</p>
                        <form onSubmit={handleLogin} className="space-y-6 text-left">
                            <input 
                                type="text" 
                                value={personalCode} 
                                onChange={(e) => setPersonalCode(e.target.value)} 
                                placeholder="개인 코드를 입력하세요" 
                                className="w-full p-5 rounded-2xl bg-slate-50 border-2 border-slate-100 focus:border-indigo-500 outline-none text-center font-bold text-lg" 
                            />
                            <button className="w-full bg-indigo-600 text-white p-5 rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition-all flex justify-center items-center">
                                {isLoading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : "탐구 기록장 입장하기"}
                            </button>
                        </form>
                        <div className="mt-12 pt-8 border-t border-slate-100 text-[11px] text-slate-400 font-bold uppercase tracking-widest">
                            공주여자고등학교 이수연 선생님 제작
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex flex-col min-h-screen">
                    <header className="no-print bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-white"><i data-lucide="book-open"></i></div>
                            <div>
                                <h2 className="serif font-black text-lg leading-none">학술적 심화 탐구 기록장</h2>
                                <p className="text-[10px] font-bold text-indigo-600 mt-1 uppercase italic tracking-tighter">Gongju Girls' High School System</p>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={saveData} className="bg-emerald-600 text-white px-5 py-2.5 rounded-xl text-xs font-black hover:bg-emerald-700 flex items-center gap-2 transition-all shadow-md">
                                <i data-lucide="save" className="w-4 h-4"></i> {isLoading ? "저장 중..." : "서버 저장"}
                            </button>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-xs font-black hover:bg-indigo-600 flex items-center gap-2 transition-all">
                                <i data-lucide="printer" className="w-4 h-4"></i> 인쇄
                            </button>
                        </div>
                    </header>

                    <nav className="no-print bg-white border-b border-slate-100 flex gap-1 overflow-x-auto px-4 py-2 scrollbar-hide">
                        {tabs.map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-shrink-0 px-5 py-3 rounded-xl font-bold text-xs flex items-center gap-2 transition-all ${activeTab === tab.id ? 'bg-indigo-50 text-indigo-700 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                                <i data-lucide={tab.icon} className="w-3.5 h-3.5"></i> {tab.title}
                            </button>
                        ))}
                    </nav>

                    <main className="no-print flex-grow p-6 md:p-12 paper-texture">
                        <div className="max-w-4xl mx-auto bg-white rounded-[40px] shadow-xl p-10 md:p-16 min-h-[600px] border border-slate-200/50">
                            {activeTab === 0 ? (
                                <div className="space-y-10">
                                    <h3 className="serif text-3xl font-black text-slate-800 border-b pb-4">학생 정보 확인</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 font-bold">
                                        {[
                                            { id: 'school', label: '소속 학교', val: studentInfo.school },
                                            { id: 'gradeClass', label: '학 번', val: studentInfo.gradeClass },
                                            { id: 'name', label: '학생 성명', val: studentInfo.name },
                                            { id: 'major', label: '관심 분야 (전공)', val: studentInfo.major }
                                        ].map(item => (
                                            <div key={item.id} className="space-y-3">
                                                <label className="text-[11px] text-indigo-500 uppercase tracking-widest ml-1">{item.label}</label>
                                                <input 
                                                    value={item.val} 
                                                    onChange={(e) => setStudentInfo({...studentInfo, [item.id]: e.target.value})} 
                                                    className="w-full p-5 rounded-2xl bg-slate-50 border border-slate-100 focus:bg-white focus:border-indigo-600 outline-none transition-all text-lg shadow-inner" 
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-8 animate-in slide-in-from-bottom-5">
                                    <h3 className="serif text-3xl font-black text-slate-800 italic underline decoration-indigo-200 underline-offset-8">
                                        {tabs.find(t=>t.id === activeTab).title} 단계
                                    </h3>
                                    <textarea 
                                        value={sessionData[tabs.find(t=>t.id === activeTab).key] || ""}
                                        onChange={(e) => {
                                            const currentKey = tabs.find(t=>t.id === activeTab).key;
                                            setSessionData({...sessionData, [currentKey]: e.target.value});
                                        }}
                                        className="w-full h-80 p-8 rounded-3xl bg-slate-50 border-none outline-none text-lg leading-relaxed focus:ring-4 focus:ring-indigo-50 transition-all shadow-inner"
                                        placeholder="이곳에 탐구 내용을 상세히 기록하세요."
                                    />
                                    {activeTab === 1 && (
                                        <div className="space-y-4 pt-4 border-t border-slate-100">
                                            <label className="text-[11px] font-black text-indigo-500 uppercase tracking-widest">최종 탐구 질문</label>
                                            <input 
                                                value={sessionData.s1_question}
                                                onChange={(e) => setSessionData({...sessionData, s1_question: e.target.value})}
                                                className="w-full p-6 rounded-2xl bg-indigo-50/50 border border-indigo-100 focus:bg-white outline-none font-bold text-xl text-indigo-900"
                                                placeholder="예: ~가 ~에 미치는 영향 분석"
                                            />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </main>

                    <footer className="no-print py-10 text-center text-slate-400 font-bold serif text-sm italic">
                        공주여자고등학교 이수연 선생님 제작 &middot; Academic Master System
                    </footer>

                    <div className="print-only">
                        <section className="page flex flex-col items-center justify-center text-center h-[297mm]">
                            <h1 className="serif text-[80px] font-black leading-none mb-20 tracking-tighter">심화 탐구<br/>통합 리포트</h1>
                            <div className="w-full max-w-lg space-y-10 text-left border-t-4 border-slate-900 pt-16 font-bold text-2xl">
                                <div className="flex justify-between border-b pb-4"><span>소 속 학 교</span><span>{studentInfo.school}</span></div>
                                <div className="flex justify-between border-b pb-4"><span>학 번</span><span>{studentInfo.gradeClass}</span></div>
                                <div className="flex justify-between border-b pb-4"><span>학 생 성 명</span><span>{studentInfo.name}</span></div>
                            </div>
                            <div className="mt-auto serif text-xl font-bold italic text-slate-400">Gongju Girls' High School &middot; Lee Su-yeon</div>
                        </section>
                    </div>
                </div>
            );
        };
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
