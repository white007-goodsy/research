<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹¬í™” íƒêµ¬ í†µí•© ì›Œí¬ë¶ (ì™„ì „íŒ)</title>

  <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f8fafc;
      color: #0f172a;
      word-break: keep-all;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    
    /* ë¡œë”© í™”ë©´ */
    #loading-screen {
      position: fixed; inset: 0; background: #0f172a; color: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
      transition: opacity 0.5s ease;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
    @media print {
      .no-print { display: none !important; }
      .print-only { display: block !important; }
      body { background: white !important; margin: 0 !important; }
      .page-break { page-break-after: always; }
      .page { 
        border: none !important; 
        box-shadow: none !important; 
        margin: 0 !important; 
        width: 100% !important;
        min-height: 297mm; /* A4 ë†’ì´ */
        padding: 20mm !important;
      }
    }
    .print-only { display: none; }

    /* ë²„íŠ¼ íš¨ê³¼ */
    .btn-ai-glow {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      transition: all 0.3s ease;
    }
    .btn-ai-glow:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.5);
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div style="width:40px;height:40px;border:4px solid #6366f1;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;"></div>
    <p style="font-weight:900;letter-spacing:2px;">SYSTEM LOADING...</p>
    <p style="font-size:12px;color:#94a3b8;margin-top:6px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
  </div>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // =========================================
    // 1. ì„¤ì • ë° ìƒìˆ˜ (CONFIG)
    // =========================================
    const CONFIG = {
      // [ì¤‘ìš”] ë°°í¬ëœ ì›¹ ì•± URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš”
      SCRIPT_URL: "https://script.google.com/macros/s/AKfycbx0zHvBa2Y93_6JrdtAHMSN9qnvvendmEd9TvN5f1f_R2wAyHNyHWT70BSMrQja6Dw/exec", 
      GEMINI_MODEL: "gemini-2.5-flash", 
      APP_VERSION: "v6.5-FullRestored",
      LOCAL_PREFIX: "master_serverB_v6_full",
    };

    const EMPTY_STUDENT = { school: "", gradeClass: "", name: "", major: "" };
    const EMPTY_SESSION = {
      s1_topic: "", s1_motive: "", s1_question: "", s1_connection: "",
      s2_book: "", s2_author: "", s2_level: "ì „ê³µ ê¸°ì´ˆ(ê°œë¡ )", s2_part: "", s2_goal: "í•™ìˆ  ë³´ê³ ì„œ",
      s3_depth: "", s3_trace: "",
      s4_keyword: "", s4_fact: "",
      s5_log: "", s5_error: "", s5_result: "",
      s8_claim: "", s8_growth: "", s8_next: "", s8_summary: "",
    };

    const TABS = [
      { id: 0, title: "ì •ë³´ ì…ë ¥", icon: "user", color: "bg-slate-900" },
      { id: 11, title: "ìë£Œê²€ìƒ‰ ë¹„ë²•", icon: "search", color: "bg-amber-600" },
      { id: 1, title: "1ì°¨ì‹œ: ì£¼ì œ&ì§ˆë¬¸", icon: "clipboard-list", color: "bg-indigo-600" },
      { id: 2, title: "2ì°¨ì‹œ: ê³„íš", icon: "calendar", color: "bg-indigo-600" },
      { id: 3, title: "3ì°¨ì‹œ: ë„ì„œë¶„ì„", icon: "book-open", color: "bg-indigo-600" },
      { id: 4, title: "4ì°¨ì‹œ: ë…¼ë¬¸ë¶„ì„", icon: "file-text", color: "bg-indigo-600" },
      { id: 13, title: "íƒêµ¬ ë°©ë²•ë¡ ", icon: "bar-chart-3", color: "bg-indigo-600" },
      { id: 5, title: "5~7ì°¨ì‹œ: ìˆ˜í–‰", icon: "wand-2", color: "bg-indigo-600" },
      { id: 12, title: "AI ê°€ì´ë“œ", icon: "shield-check", color: "bg-rose-600" },
      { id: 8, title: "8~10ì°¨ì‹œ: ì„±ì°°", icon: "graduation-cap", color: "bg-indigo-600" },
    ];

    const makeLocalKey = (userKey, kind) => `${CONFIG.LOCAL_PREFIX}:${CONFIG.APP_VERSION}:${String(userKey).trim()}:${kind}`;

    // =========================================
    // 2. ê³µí†µ UI ì»´í¬ë„ŒíŠ¸
    // =========================================
    const Label = ({ children }) => (
      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 block mb-2">
        {children}
      </label>
    );

    const InputField = ({ label, name, value, onChange, placeholder, type = "text" }) => (
      <div className="space-y-2">
        {label && <Label>{label}</Label>}
        <input 
          type={type} name={name} value={value} onChange={onChange} placeholder={placeholder}
          className="w-full p-6 rounded-3xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none font-black text-xl transition-all shadow-sm"
        />
      </div>
    );

    const TextAreaField = ({ label, name, value, onChange, placeholder, height = "h-32", bgColor="bg-slate-50", textColor="text-slate-900" }) => (
      <div className="space-y-2">
        {label && <Label>{label}</Label>}
        <textarea 
          name={name} value={value} onChange={onChange} placeholder={placeholder}
          className={`w-full ${height} p-6 rounded-[32px] ${bgColor} ${textColor} border-none outline-none font-medium text-base leading-relaxed resize-none shadow-inner`}
        />
      </div>
    );

    // =========================================
    // 3. ì„œë¸Œ ì»´í¬ë„ŒíŠ¸ ì •ì˜
    // =========================================

    // [ë¡œê·¸ì¸ í™”ë©´]
    const LoginScreen = ({ personalCode, setPersonalCode, handleLogin, serverStatus }) => (
      <div className="fixed inset-0 z-[1000] bg-slate-900 flex items-center justify-center p-6">
        <div className="w-full max-w-md bg-white rounded-[48px] p-12 shadow-2xl fade-in text-center border border-white/20">
          <div className="mb-8 flex justify-center"><div className="bg-indigo-100 p-4 rounded-3xl text-indigo-600"><i data-lucide="key" className="w-8 h-8"></i></div></div>
          <h2 className="text-3xl font-black text-slate-900 tracking-tight">ê°œì¸ ì½”ë“œ ë¡œê·¸ì¸</h2>
          <p className="text-slate-500 mt-3 font-medium text-sm">ê¸°ì¡´ ì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</p>
          <input 
            value={personalCode} onChange={e => setPersonalCode(e.target.value)} 
            onKeyDown={e => e.key === 'Enter' && handleLogin()}
            className="mt-10 w-full p-6 rounded-3xl bg-slate-100 border-2 border-transparent focus:border-indigo-500 outline-none font-black text-center text-2xl tracking-widest"
            placeholder="ì˜ˆ: 20101í™ê¸¸ë™"
          />
          {serverStatus && <p className="mt-4 text-xs font-bold text-indigo-600 bg-indigo-50 py-2 rounded-full">{serverStatus}</p>}
          <button onClick={handleLogin} className="mt-8 w-full bg-slate-900 text-white py-5 rounded-[24px] font-black text-lg shadow-xl active:scale-95 transition-all">ì‹œìŠ¤í…œ ì ‘ì†</button>
        </div>
      </div>
    );

    // [ìƒë‹¨ í—¤ë”]
    const Header = ({ serverStatus, handleSaveAll, handleLogout }) => (
      <header className="bg-slate-900 text-white p-5 px-8 flex justify-between items-center sticky top-0 z-50 shadow-2xl">
        <div className="flex items-center gap-4">
          <div className="bg-indigo-500 p-2.5 rounded-2xl shadow-lg"><i data-lucide="zap" className="w-5 h-5"></i></div>
          <div>
            <h1 className="text-xl font-black tracking-tighter leading-none">ì‹¬í™” íƒêµ¬ í†µí•© ì›Œí¬ë¶</h1>
            <p className="text-slate-400 text-[9px] font-bold uppercase tracking-[0.3em] mt-1.5">v6.5 Full Restored</p>
          </div>
        </div>
        <div className="flex gap-2.5 items-center">
          {serverStatus && <span className="text-[10px] font-black bg-white/5 border border-white/10 px-4 py-2 rounded-xl">{serverStatus}</span>}
          <button onClick={handleSaveAll} className="bg-indigo-600 hover:bg-indigo-500 px-5 py-2.5 rounded-2xl text-xs font-black flex items-center gap-2 shadow-lg transition-all active:scale-95">
            <i data-lucide="save" className="w-3.5 h-3.5"></i> ì„œë²„ ì €ì¥
          </button>
          <button onClick={() => window.print()} className="bg-white/10 hover:bg-white/20 px-5 py-2.5 rounded-2xl text-xs font-black flex items-center gap-2 border border-white/5 active:scale-95 transition-all">
            <i data-lucide="printer" className="w-3.5 h-3.5"></i> ì¸ì‡„
          </button>
          <button onClick={handleLogout} className="bg-rose-600 hover:bg-rose-500 px-5 py-2.5 rounded-2xl text-xs font-black active:scale-95 transition-all">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </header>
    );

    // [íƒ­ ë„¤ë¹„ê²Œì´ì…˜]
    const TabNavigation = ({ activeTab, setActiveTab, setAiResult }) => (
      <nav className="bg-white border-b flex gap-1.5 overflow-x-auto p-3 px-6 scrollbar-hide sticky top-[76px] z-40 shadow-sm">
        {TABS.map(tab => (
          <button key={tab.id} onClick={() => { setActiveTab(tab.id); setAiResult(""); }} 
            className={`flex-shrink-0 px-5 py-3 rounded-2xl border font-black text-[11px] flex items-center gap-2.5 transition-all ${
              activeTab === tab.id ? `${tab.color} text-white shadow-xl scale-105 ring-4 ring-indigo-50` : "bg-white text-slate-500 border-slate-100 hover:bg-slate-50"
            }`}>
            <i data-lucide={tab.icon} className="w-3.5 h-3.5"></i> {tab.title}
          </button>
        ))}
      </nav>
    );

    // [AI ê²°ê³¼ íŒì—…]
    const AiResultBox = ({ loading, result, onClose }) => (
      (loading || result) ? (
        <div className="mb-10 bg-white border-2 border-indigo-100 rounded-[40px] p-10 shadow-2xl border-l-[16px] border-l-indigo-600 fade-in">
          <div className="flex items-center justify-between mb-6 pb-6 border-b">
            <div className="flex items-center gap-3 text-indigo-600 font-black text-lg"><i data-lucide="sparkles" className="w-6 h-6"></i> AI íŠœí„°ì˜ íƒêµ¬ ì •ë°€ ì§„ë‹¨</div>
            <button onClick={onClose} className="text-slate-300 hover:text-slate-900"><i data-lucide="x" className="w-6 h-6"></i></button>
          </div>
          {loading ? (
            <div className="flex flex-col items-center py-10">
              <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
              <p className="text-base font-bold text-slate-500 tracking-tight">í•™ìƒì˜ ë°ì´í„°ë¥¼ í•™ìˆ ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì²˜ë°©ì„ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
          ) : (
            <div className="text-base font-medium leading-relaxed whitespace-pre-wrap text-slate-800 bg-slate-50 p-8 rounded-3xl border border-slate-100 shadow-inner">{result}</div>
          )}
        </div>
      ) : null
    );

    // [íƒ­ ì»¨í…ì¸  - ëª¨ë“  ìƒì„¸ íƒ­ ë³µêµ¬ë¨]
    const TabContent = ({ activeTab, studentInfo, sessionData, handleStudent, handleInput, handleAiConsult, aiLoading }) => {
      const SectionHeader = ({ title, subTitle, btnText, onBtnClick }) => (
        <div className="flex justify-between items-center border-b pb-8 mb-8">
          <div>
            <h2 className="text-4xl font-black text-slate-900 tracking-tighter">{title}</h2>
            {subTitle && <p className="text-slate-400 font-bold mt-1 text-xs uppercase">{subTitle}</p>}
          </div>
          {btnText && (
            <button onClick={onBtnClick} disabled={aiLoading} className="btn-ai-glow text-white px-8 py-4 rounded-3xl text-sm font-black flex items-center gap-2 active:scale-95 shadow-2xl">
              <i data-lucide="sparkles" className="w-5 h-5 text-amber-300"></i> {btnText}
            </button>
          )}
        </div>
      );

      switch(activeTab) {
        case 0: return (
          <div className="space-y-12 fade-in">
            <SectionHeader title="ì •ë³´ ì…ë ¥" subTitle="Personal Profile" />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <InputField label="í•™êµëª…" name="school" value={studentInfo.school} onChange={handleStudent} placeholder="OOê³ ë“±í•™êµ" />
              <InputField label="í•™ë²ˆ" name="gradeClass" value={studentInfo.gradeClass} onChange={handleStudent} placeholder="ì˜ˆ: 20101" />
              <InputField label="ì„±ëª…" name="name" value={studentInfo.name} onChange={handleStudent} placeholder="í™ê¸¸ë™" />
              <InputField label="í¬ë§ ì „ê³µ" name="major" value={studentInfo.major} onChange={handleStudent} placeholder="ì˜ˆ: ìƒëª…ê³µí•™" />
            </div>
            <div className="mt-10 p-8 bg-indigo-50/50 rounded-[32px] border border-indigo-100 italic font-bold text-indigo-800 text-sm">
              â€» ì…ë ¥ ì •ë³´ëŠ” ë¦¬í¬íŠ¸ì˜ í‘œì§€ ë° AI ë¶„ì„ ì‹œ ê¸°ì´ˆ ìë£Œë¡œ í™œìš©ë©ë‹ˆë‹¤.
            </div>
          </div>
        );
        case 11: return (
          <div className="space-y-10 fade-in">
            <h2 className="text-4xl font-black text-amber-600 flex items-center gap-4">
              <i data-lucide="search" className="w-10 h-10"></i> ìë£Œ ê²€ìƒ‰ ë¹„ë²• (R-Master)
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              <div className="bg-amber-50 p-8 rounded-[40px] border border-amber-100 shadow-sm">
                <h3 className="font-black text-amber-900 text-lg mb-4">â‘  í•™ìˆ DB í•„í„°ë§</h3>
                <ul className="text-sm text-amber-800 font-bold space-y-3">
                  <li>- DBpia/RISS ìµœê·¼ 3ë…„ ì´ë‚´ ë…¼ë¬¸</li>
                  <li>- 'KCI ë“±ì¬' ë…¼ë¬¸ ìš°ì„  í™•ì¸</li>
                  <li>- ì´ˆë¡(Abstract)ì˜ ê²°ê³¼ ìœ„ì£¼ í™•ì¸</li>
                </ul>
              </div>
              <div className="bg-indigo-50 p-8 rounded-[40px] border border-indigo-100 shadow-sm">
                <h3 className="font-black text-indigo-900 text-lg mb-4">â‘¡ ê³ ê¸‰ ê²€ìƒ‰ ë¬¸ë²•</h3>
                <ul className="text-sm text-indigo-800 font-bold space-y-3">
                  <li>- AND: ë‘ í‚¤ì›Œë“œ ëª¨ë‘ í¬í•¨</li>
                  <li>- OR: í•œ í‚¤ì›Œë“œë¼ë„ í¬í•¨</li>
                  <li>- " ": ì •í™•í•œ ë¬¸ì¥ ê²€ìƒ‰</li>
                </ul>
              </div>
              <div className="bg-slate-900 p-8 rounded-[40px] text-white shadow-xl">
                <h3 className="font-black text-indigo-400 text-lg mb-4">â‘¢ í†µê³„ ë° ì›ë°ì´í„°</h3>
                <ul className="text-sm font-bold space-y-3">
                  <li>- KOSIS êµ­ê°€í†µê³„í¬í„¸</li>
                  <li>- ê³µê³µë°ì´í„°í¬í„¸(data.go.kr)</li>
                  <li>- ê° ê¸°ê´€ ë³´ë„ìë£Œ í†µê³„</li>
                </ul>
              </div>
            </div>
          </div>
        );
        case 1: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="1ì°¨ì‹œ: ì£¼ì œ & ì§ˆë¬¸" subTitle="Research Topic & Question" btnText="AI ì£¼ì œ ì •êµí™”" onBtnClick={handleAiConsult} />
            <div className="space-y-10">
              <InputField label="íƒêµ¬ ì£¼ì œ (ê°€ì œ)" name="s1_topic" value={sessionData.s1_topic} onChange={handleInput} placeholder="ì˜ˆ: ì¬ìƒ ì—ë„ˆì§€ë¥¼ í™œìš©í•œ ì¹œí™˜ê²½ ë„ì‹œ ì„¤ê³„ ë°©ì•ˆ ì—°êµ¬" />
              <TextAreaField label="íƒêµ¬ ë™ê¸° ë° ê³„ê¸°" name="s1_motive" value={sessionData.s1_motive} onChange={handleInput} height="h-40" placeholder="ìˆ˜ì—… ì¤‘ ìƒê¸´ ê¶ê¸ˆì¦ì´ë‚˜ ì‚¬íšŒì  ì‚¬ê±´ ë“± êµ¬ì²´ì ì¸ ë™ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”." />
              <InputField label="í•µì‹¬ íƒêµ¬ ì§ˆë¬¸ (RQ)" name="s1_question" value={sessionData.s1_question} onChange={handleInput} placeholder="ì˜ˆ: ì–´ë–¤ ë³€ì¸ì´ ê²°ê³¼ì— ê°€ì¥ í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ”ê°€?" />
              <TextAreaField label="êµê³¼/ì „ê³µ ì—°ê²° ê³ ë¦¬" name="s1_connection" value={sessionData.s1_connection} onChange={handleInput} placeholder="êµê³¼ì„œì˜ ì–´ë–¤ ì›ë¦¬ê°€ ì „ê³µì˜ ì–´ë–¤ ê°œë…ê³¼ ì—°ê²°ë˜ë‚˜ìš”?" />
            </div>
          </div>
        );
        case 2: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="2ì°¨ì‹œ: ë„ì„œ ë° íƒêµ¬ ê³„íš" btnText="AI í‚¤ì›Œë“œ ì¶”ì¶œ" onBtnClick={handleAiConsult} />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <InputField label="ì‹¬í™” ë„ì„œëª…" name="s2_book" value={sessionData.s2_book} onChange={handleInput} placeholder="ì±… ì œëª©" />
              <InputField label="ì €ì" name="s2_author" value={sessionData.s2_author} onChange={handleInput} placeholder="ì €ìëª…" />
              <div className="space-y-4">
                <Label>ë„ì„œ ë‚œì´ë„</Label>
                <select name="s2_level" value={sessionData.s2_level} onChange={handleInput} className="w-full p-6 rounded-3xl bg-slate-50 font-black text-lg appearance-none outline-none focus:ring-4 focus:ring-indigo-100"><option>ì „ê³µ ê¸°ì´ˆ(ê°œë¡ )</option><option>ì „ë¬¸ í•™ìˆ ì„œ</option><option>êµì–‘ì„œ</option><option>ì›ì „/ê³ ì „</option></select>
              </div>
              <div className="space-y-4">
                <Label>ìµœì¢… ì‚°ì¶œë¬¼ ëª©í‘œ</Label>
                <select name="s2_goal" value={sessionData.s2_goal} onChange={handleInput} className="w-full p-6 rounded-3xl bg-slate-50 font-black text-lg appearance-none outline-none focus:ring-4 focus:ring-indigo-100"><option>í•™ìˆ  ë³´ê³ ì„œ</option><option>ë°ì´í„° ë¦¬í¬íŠ¸</option><option>ì‹¤í—˜ ë³´ê³ ì„œ</option><option>ì •ì±… ì œì•ˆì„œ</option></select>
              </div>
            </div>
            <InputField label="ì§‘ì¤‘ íƒë… ì§€ì  (ë°œì·Œë… ì±•í„°)" name="s2_part" value={sessionData.s2_part} onChange={handleInput} placeholder="ì˜ˆ: ì œ3ì¥ ë°ì´í„° ë¦¬í„°ëŸ¬ì‹œì˜ ì‹¤ì œì  ì ìš© ì‚¬ë¡€" />
          </div>
        );
        case 3: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="3ì°¨ì‹œ: ë„ì„œ ì‹¬í™” ë¶„ì„" btnText="ì§€ì‹ ì •êµí™” ì½”ì¹­" onBtnClick={handleAiConsult} />
            <TextAreaField label="êµê³¼ì„œ ë„ˆë¨¸ì˜ ì§€ì‹ (Depth Analysis)" name="s3_depth" value={sessionData.s3_depth} onChange={handleInput} height="h-80" placeholder="ë„ì„œë¥¼ í†µí•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ í•™ìˆ ì  ì›ë¦¬ë¥¼ ìƒì„¸íˆ ì •ë¦¬í•˜ì„¸ìš”." />
            <InputField label="ì¶”ê°€ ìë£Œ ì¶”ì " name="s3_trace" value={sessionData.s3_trace} onChange={handleInput} placeholder="ì±…ì—ì„œ ì–¸ê¸‰ëœ ë…¼ë¬¸ì´ë‚˜ ë‹¤ë¥¸ ë„ì„œ ë¦¬ìŠ¤íŠ¸" />
          </div>
        );
        case 4: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="4ì°¨ì‹œ: ë…¼ë¬¸ ë°ì´í„° ë¶„ì„" subTitle="Scholarly Evidence & Facts" btnText="AI ì£¼ê·¼ì„¤ ë¬¸ì¥ ìƒì„±" onBtnClick={handleAiConsult} />
            <TextAreaField label="ìµœì‹  í•™ìˆ  íŠ¸ë Œë“œ/í‚¤ì›Œë“œ" name="s4_keyword" value={sessionData.s4_keyword} onChange={handleInput} placeholder="ë…¼ë¬¸ë“¤ì—ì„œ ê³µí†µì ìœ¼ë¡œ ë‹¤ë£¨ëŠ” í•µì‹¬ ë¬¸ì œì˜ì‹" />
            <TextAreaField label="í•µì‹¬ ìˆ«ìì™€ íŒ©íŠ¸ (Core Evidence)" name="s4_fact" value={sessionData.s4_fact} onChange={handleInput} height="h-64" bgColor="bg-indigo-50/30" textColor="text-indigo-900" placeholder="ë³´ê³ ì„œì˜ ê·¼ê±°ê°€ ë  í†µê³„ ìˆ˜ì¹˜, ì‹¤í—˜ ê²°ê³¼, í‘œì˜ ë°ì´í„° ë“±ì„ ì¶œì²˜ì™€ í•¨ê»˜ ê¸°ë¡í•˜ì„¸ìš”." />
          </div>
        );
        case 13: return (
          <div className="space-y-12 fade-in">
            <h2 className="text-4xl font-black text-indigo-600 tracking-tighter">ğŸ“Š íƒêµ¬ ë°©ë²•ë¡  ë§ˆìŠ¤í„° ê°€ì´ë“œ</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-indigo-50 p-10 rounded-[48px] border-2 border-indigo-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="database" className="w-20 h-20"></i></div>
                <h3 className="font-black text-indigo-900 text-2xl mb-4">â‘  ë°ì´í„° ì¬í•´ì„í˜•</h3>
                <p className="text-sm text-indigo-800 leading-relaxed font-bold">ê³µê³µë°ì´í„°ë‚˜ í†µê³„ ìˆ˜ì¹˜ë¥¼ ìƒˆë¡œìš´ ê°€ì„¤ë¡œ ì—°ê²°í•˜ì—¬ ì‹œê°í™”í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.</p>
              </div>
              <div className="bg-emerald-50 p-10 rounded-[48px] border-2 border-emerald-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="shuffle" className="w-20 h-20"></i></div>
                <h3 className="font-black text-emerald-900 text-2xl mb-4">â‘¡ ì‚¬ë¡€ ë¹„êµí˜•</h3>
                <p className="text-sm text-emerald-800 leading-relaxed font-bold">ë™ì¼í•œ ë³€ì¸ì„ ê°€ì§„ ë‹¤ë¥¸ ì‚¬ë¡€ Aì™€ Bë¥¼ ëŒ€ì¡°í•˜ì—¬ ì°¨ì´ì˜ ì›ì¸ì„ íƒêµ¬í•©ë‹ˆë‹¤.</p>
              </div>
              <div className="bg-rose-50 p-10 rounded-[48px] border-2 border-rose-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="test-tube" className="w-20 h-20"></i></div>
                <h3 className="font-black text-rose-900 text-2xl mb-4">â‘¢ ê°€ì„¤ ì‹¤í—˜í˜•</h3>
                <p className="text-sm text-rose-800 leading-relaxed font-bold">íŠ¹ì • ë³€ì¸ì„ í†µì œí•œ ìƒíƒœì—ì„œ ì‹¤í—˜ì„ ìˆ˜í–‰í•˜ê³  ì˜ˆì¸¡ê°’ê³¼ ì‹¤ì œê°’ì„ ë¹„êµí•©ë‹ˆë‹¤.</p>
              </div>
              <div className="bg-amber-50 p-10 rounded-[48px] border-2 border-amber-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="pen-tool" className="w-20 h-20"></i></div>
                <h3 className="font-black text-amber-900 text-2xl mb-4">â‘£ ì´ë¡  ì ìš©í˜•</h3>
                <p className="text-sm text-amber-800 leading-relaxed font-bold">ì¶”ìƒì ì¸ ì „ê³µ ì´ë¡ ì„ ì‹¤ì œ ì‚¬íšŒ í˜„ìƒì´ë‚˜ ê¸°ì—… ì‚¬ë¡€ì— ëŒ€ì…í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.</p>
              </div>
            </div>
            <div className="bg-slate-900 p-10 rounded-[48px] text-white shadow-2xl">
              <h3 className="font-black text-indigo-400 text-xl mb-4 tracking-tighter">ğŸ’¡ ì£¼ê·¼ì„¤ ë¬¸ì¥ ê³µì‹</h3>
              <p className="text-lg leading-relaxed font-bold italic">"[ìë£Œì¶œì²˜/ì—°ë„]ì— ì˜í•˜ë©´ [A] ì§€í‘œê°€ [N] ìˆ˜ì¹˜ë¡œ ë‚˜íƒ€ë‚¨. ì´ëŠ” [í•™ìŠµí•œ ì›ë¦¬]ì— ë¹„ì¶”ì–´ ë³¼ ë•Œ [í•´ì„/ë¶„ì„]ìœ¼ë¡œ íŒë‹¨í•  ìˆ˜ ìˆìŒ."</p>
            </div>
          </div>
        );
        case 5: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="5~7ì°¨ì‹œ: ìˆ˜í–‰ ë° ë…¸ë ¥ ê¸°ë¡" subTitle="Action Log & Failure Record" btnText="ìˆ˜í–‰ ì½”ì¹­ ìš”ì²­" onBtnClick={handleAiConsult} />
            <TextAreaField label="ì§„ì§œ ë…¸ë ¥ ì¼ì§€ (Action Log)" name="s5_log" value={sessionData.s5_log} onChange={handleInput} height="h-48" placeholder="ë°©ë¬¸ ì‚¬ì´íŠ¸, ë°ì´í„° ê°€ê³µ ê³¼ì •, ì°¸ê³ í•œ ìˆ˜ì‹ ë“± êµ¬ì²´ì ì¸ í–‰ìœ„ë¥¼ ë‚ ì§œë³„ë¡œ ê¸°ë¡í•˜ì„¸ìš”." />
            <TextAreaField label="ì‹œí–‰ì°©ì˜¤ ë° ì‹¤íŒ¨ ê¸°ë¡ (Error Log)" name="s5_error" value={sessionData.s5_error} onChange={handleInput} height="h-32" bgColor="bg-rose-50/50" textColor="text-rose-900 italic" placeholder="ìë£Œê°€ ì—†ì–´ì„œ ì‹¤íŒ¨í–ˆê±°ë‚˜ ê°€ì„¤ì´ í‹€ë ¸ë˜ ì§€ì  ë“± ì‹¤íŒ¨ì˜ í”ì ì„ ì†”ì§íˆ ì ìœ¼ì„¸ìš”." />
            <TextAreaField label="ì¤‘ê°„ ì‚°ì¶œë¬¼ (Interim Result)" name="s5_result" value={sessionData.s5_result} onChange={handleInput} height="h-32" bgColor="bg-emerald-50/50" textColor="text-emerald-900" placeholder="ë„ì¶œëœ í‘œ, ê·¸ë˜í”„ì˜ ìˆ˜ì¹˜ë‚˜ í•µì‹¬ ì¤‘ê°„ ê²°ë¡ ì„ ì ìœ¼ì„¸ìš”." />
          </div>
        );
        case 12: return (
          <div className="space-y-12 fade-in text-center py-16">
            <div className="bg-rose-50 p-16 rounded-[80px] border-4 border-rose-100 max-w-3xl mx-auto shadow-2xl">
              <i data-lucide="alert-triangle" className="w-20 h-20 text-rose-500 mx-auto mb-8"></i>
              <h2 className="text-4xl font-black text-rose-900 tracking-tighter mb-6">AIëŠ” ë°œí’ˆì„ ëŒ€ì‹  íŒ”ì§€ ì•ŠìŠµë‹ˆë‹¤.</h2>
              <p className="text-xl text-rose-800 leading-relaxed font-bold mb-10 italic">
                ì‚¬ì •ê´€ì€ ë§¤ë„ëŸ¬ìš´ AI ë¬¸ì¥ë³´ë‹¤<br />ì—¬ëŸ¬ë¶„ì˜ ê±°ì¹ ê³  íˆ¬ë°•í•œ 'ì‹œí–‰ì°©ì˜¤ ê¸°ë¡'ì„ ë” ì‹ ë¢°í•©ë‹ˆë‹¤.
              </p>
              <div className="text-left bg-white/60 p-10 rounded-[40px] space-y-6 font-bold text-base text-rose-950 border border-rose-200 shadow-inner">
                <p className="flex gap-4"><i data-lucide="check-circle" className="w-6 h-6 shrink-0 text-rose-600"></i> AIëŠ” ë…¼ë¦¬ êµ¬ì¡°ë¥¼ ì¡ëŠ” ë³´ì¡° ë„êµ¬ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.</p>
                <p className="flex gap-4"><i data-lucide="check-circle" className="w-6 h-6 shrink-0 text-rose-600"></i> ë°˜ë“œì‹œ ì§ì ‘ ì°¾ì€ 'ìˆ«ì'ì™€ 'ë°ì´í„°'ë¥¼ í”„ë¡¬í”„íŠ¸ì— ë„£ìœ¼ì„¸ìš”.</p>
                <p className="flex gap-4"><i data-lucide="check-circle" className="w-6 h-6 shrink-0 text-rose-600"></i> ë§¤ë„ëŸ½ê²Œ ìˆ˜ì •í•´ë‹¬ë¼ëŠ” ìš”ì²­ë³´ë‹¤, ë…¼ë¦¬ì˜ í—ˆì ì„ ì°¾ì•„ë‹¬ë¼ê³  í•˜ì„¸ìš”.</p>
              </div>
            </div>
          </div>
        );
        case 8: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="8~10ì°¨ì‹œ: ì„±ì°° ë° ìµœì¢… ìš”ì•½" subTitle="Synthesis & Final Portfolio" btnText="AI ì„¸íŠ¹ ì´ˆì•ˆ ì™„ì„±" onBtnClick={handleAiConsult} />
            <TextAreaField label="ìµœì¢… ì£¼ì¥ (Final Claim)" name="s8_claim" value={sessionData.s8_claim} onChange={handleInput} height="h-32" placeholder="íƒêµ¬ ê²°ê³¼ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ì •ì˜í•œë‹¤ë©´?" />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <TextAreaField label="ì„±ì¥ ë° ë°°ìš´ ì " name="s8_growth" value={sessionData.s8_growth} onChange={handleInput} height="h-40" placeholder="ê°œë…/ê¸°ìˆ /íƒœë„ ì¸¡ë©´ì—ì„œì˜ ë³€í™”" />
              <TextAreaField label="í›„ì† íƒêµ¬ ì œì–¸" name="s8_next" value={sessionData.s8_next} onChange={handleInput} height="h-40" placeholder="í•œê³„ì ê³¼ ë‹¤ìŒ ì—°êµ¬ ë°©í–¥" />
            </div>
            <div className="p-12 bg-slate-900 text-white rounded-[64px] shadow-2xl relative overflow-hidden">
              <div className="absolute top-0 right-0 p-10 opacity-10"><i data-lucide="graduation-cap" className="w-40 h-40 text-indigo-400"></i></div>
              <Label><span className="text-indigo-400">ğŸ“ ìƒí™œê¸°ë¡ë¶€ ìš”ì•½ë³¸ (FINAL SUMMARY)</span></Label>
              <textarea name="s8_summary" value={sessionData.s8_summary} onChange={handleInput} className="w-full h-72 bg-transparent border-none outline-none text-xl font-black leading-relaxed mt-6 resize-none scrollbar-hide relative z-10" placeholder="[ë™ê¸°-ê³¼ì •-ì„±ì¥-í›„ì†] êµ¬ì¡°ë¡œ 10ì°¨ì‹œ ì—¬ì •ì„ 500ì ì´ë‚´ë¡œ ì™„ê²°í•˜ì„¸ìš”." />
            </div>
          </div>
        );
        default: return <div className="p-10 text-center font-bold text-slate-400">ì„ íƒëœ íƒ­ì˜ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>;
      }
    };

    // [ì¸ì‡„ í™”ë©´ - ì „ì²´ ë³µêµ¬]
    const PrintView = ({ studentInfo, sessionData, issueDate }) => (
      <div className="print-only bg-white text-slate-900 w-full font-serif">
        
        {/* 1í˜ì´ì§€: í‘œì§€ */}
        <div className="page flex flex-col justify-between p-24 border-[30px] border-double border-slate-900 m-10">
          <div className="mt-20">
            <div className="flex gap-4 items-center mb-10">
              <div className="bg-slate-900 text-white p-3 font-black text-xs uppercase tracking-widest">Premium Research Report</div>
            </div>
            <h1 className="text-8xl font-black tracking-tighter leading-tight mb-6">ì‹¬í™” íƒêµ¬<br />í†µí•© ì›Œí¬ë¶</h1>
            <p className="text-3xl font-bold text-slate-400 uppercase tracking-[0.4em] mb-40">Comprehensive Research Workbook</p>
            
            <div className="grid grid-cols-2 gap-y-16 gap-x-32 pt-20 border-t-8 border-slate-900">
              <div><p className="text-sm font-black text-slate-400 mb-4 uppercase">Institution</p><p className="text-5xl font-black">{studentInfo.school || "ë¯¸ì…ë ¥"}</p></div>
              <div><p className="text-sm font-black text-slate-400 mb-4 uppercase">Target Major</p><p className="text-5xl font-black">{studentInfo.major || "ë¯¸ì…ë ¥"}</p></div>
              <div><p className="text-sm font-black text-slate-400 mb-4 uppercase">Student Info</p><p className="text-5xl font-black">{studentInfo.gradeClass} {studentInfo.name || "ë¯¸ì…ë ¥"}</p></div>
              <div><p className="text-sm font-black text-slate-400 mb-4 uppercase">Issued Date</p><p className="text-5xl font-black">{issueDate}</p></div>
            </div>
          </div>
          <div className="text-right text-slate-300 font-black italic text-xl">MASTER SYSTEM v5.4 FULL EDITION</div>
        </div>

        <div className="page-break"></div>

        {/* 2í˜ì´ì§€: íƒêµ¬ ì§ˆë¬¸ ë° ì„¤ê³„ */}
        <div className="page p-20 space-y-16 min-h-[290mm]">
          <h2 className="text-5xl font-black border-b-8 border-slate-900 pb-6 uppercase tracking-tighter">01. íƒêµ¬ ì„¤ê³„ ë° ë°°ê²½</h2>
          <div className="space-y-12">
            <div className="p-12 bg-slate-50 border-4 border-slate-100 rounded-[48px]">
              <h3 className="text-sm font-black text-slate-400 mb-4 uppercase">[Research Topic]</h3>
              <p className="text-4xl font-black text-indigo-900 leading-tight">{sessionData.s1_topic || "ì…ë ¥ëœ íƒêµ¬ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤."}</p>
            </div>
            <div className="p-12 bg-slate-50 border-4 border-slate-100 rounded-[48px]">
              <h3 className="text-sm font-black text-slate-400 mb-4 uppercase">[Core Question]</h3>
              <p className="text-3xl font-black text-slate-800 leading-tight">{sessionData.s1_question || "ì…ë ¥ëœ íƒêµ¬ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."}</p>
            </div>
            <div className="grid grid-cols-1 gap-12">
              <div>
                <h3 className="text-sm font-black text-slate-400 mb-4 uppercase border-b-2 pb-2 inline-block">[Motivation]</h3>
                <p className="text-xl font-medium leading-relaxed whitespace-pre-wrap">{sessionData.s1_motive}</p>
              </div>
              <div>
                <h3 className="text-sm font-black text-slate-400 mb-4 uppercase border-b-2 pb-2 inline-block">[Academic Connection]</h3>
                <p className="text-xl font-medium leading-relaxed whitespace-pre-wrap">{sessionData.s1_connection}</p>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-12 border-t-2 pt-10">
              <div><h3 className="text-sm font-black text-slate-400 mb-2">[Target Book]</h3><p className="text-2xl font-black">{sessionData.s2_book}</p></div>
              <div><h3 className="text-sm font-black text-slate-400 mb-2">[Final Goal]</h3><p className="text-2xl font-black">{sessionData.s2_goal}</p></div>
            </div>
          </div>
        </div>

        <div className="page-break"></div>

        {/* 3í˜ì´ì§€: ë°ì´í„° ë¶„ì„ ë° ìˆ˜í–‰ */}
        <div className="page p-20 space-y-16 min-h-[290mm]">
          <h2 className="text-5xl font-black border-b-8 border-slate-900 pb-6 uppercase tracking-tighter">02. ë°ì´í„° ë¶„ì„ ë° ìˆ˜í–‰ ê³¼ì •</h2>
          <div className="space-y-12">
            <div className="bg-slate-900 text-white p-16 rounded-[64px] shadow-xl relative overflow-hidden">
               <div className="absolute top-0 right-0 p-8 opacity-10"><i data-lucide="bar-chart-2" className="w-40 h-40"></i></div>
               <h3 className="text-xs font-black text-indigo-400 mb-6 uppercase tracking-widest">[Core Evidence & Data]</h3>
               <p className="text-2xl font-bold leading-relaxed whitespace-pre-wrap relative z-10">{sessionData.s4_fact}</p>
            </div>
            <div>
              <h3 className="text-sm font-black text-slate-400 mb-4 uppercase border-b-2 pb-2 inline-block">[Knowledge Depth]</h3>
              <p className="text-xl font-medium leading-relaxed whitespace-pre-wrap">{sessionData.s3_depth}</p>
            </div>
            <div className="p-10 bg-slate-50 border-2 border-slate-100 rounded-[48px]">
              <h3 className="text-sm font-black text-slate-400 mb-4 uppercase">[Action Log]</h3>
              <p className="text-lg font-bold leading-relaxed whitespace-pre-wrap">{sessionData.s5_log}</p>
            </div>
          </div>
        </div>

        <div className="page-break"></div>

        {/* 4í˜ì´ì§€: ìµœì¢… ê²°ê³¼ ë° ì„¸íŠ¹ */}
        <div className="page p-20 space-y-16 min-h-[290mm]">
          <h2 className="text-5xl font-black border-b-8 border-slate-900 pb-6 uppercase tracking-tighter">03. ìµœì¢… ì„±ì°° ë° ë¦¬í¬íŠ¸ ìš”ì•½</h2>
          <div className="space-y-12">
            <div className="p-16 bg-indigo-600 text-white rounded-[72px] shadow-2xl">
              <h3 className="text-xs font-black text-indigo-300 mb-6 uppercase tracking-widest">[Final Thesis / Claim]</h3>
              <p className="text-4xl font-black leading-tight">{sessionData.s8_claim}</p>
            </div>
            <div className="grid grid-cols-2 gap-16">
              <div>
                <h3 className="text-sm font-black text-slate-400 mb-4 uppercase border-b-2 pb-2 inline-block">[Growth & Insight]</h3>
                <p className="text-xl font-bold leading-relaxed whitespace-pre-wrap">{sessionData.s8_growth}</p>
              </div>
              <div>
                <h3 className="text-sm font-black text-slate-400 mb-4 uppercase border-b-2 pb-2 inline-block">[Further Research]</h3>
                <p className="text-xl font-bold leading-relaxed whitespace-pre-wrap">{sessionData.s8_next}</p>
              </div>
            </div>
            <div className="mt-20 p-20 bg-slate-50 rounded-[80px] border-[10px] border-double border-indigo-200">
              <h3 className="text-3xl font-black text-indigo-950 mb-8 flex items-center gap-3">
                <i data-lucide="graduation-cap" className="w-10 h-10"></i> ìƒí™œê¸°ë¡ë¶€ ìµœì¢… ìš”ì•½ë³¸
              </h3>
              <p className="text-2xl font-bold leading-loose whitespace-pre-wrap">
                {sessionData.s8_summary || "ìš”ì•½ë³¸ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}
              </p>
            </div>
          </div>
        </div>
      </div>
    );

    // =========================================
    // 4. ë©”ì¸ App ì»´í¬ë„ŒíŠ¸
    // =========================================
    const App = () => {
      const [personalCode, setPersonalCode] = useState("");
      const [activeUserKey, setActiveUserKey] = useState(""); 
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [serverStatus, setServerStatus] = useState("");
      const [studentInfo, setStudentInfo] = useState({ ...EMPTY_STUDENT });
      const [sessionData, setSessionData] = useState({ ...EMPTY_SESSION });
      const [activeTab, setActiveTab] = useState(0);
      const [aiLoading, setAiLoading] = useState(false);
      const [aiResult, setAiResult] = useState("");
      const [issueDate] = useState(() => new Date().toLocaleDateString());

      const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };

      useEffect(() => {
        const timer = setTimeout(() => {
          const loader = document.getElementById("loading-screen");
          if (loader) { loader.style.opacity = "0"; setTimeout(() => { loader.style.display = "none"; }, 500); }
          refreshIcons();
        }, 800);
        return () => clearTimeout(timer);
      }, []);

      useEffect(() => { setTimeout(refreshIcons, 100); }, [activeTab, aiResult, isLoggedIn]);

      const handleLogin = async () => {
        const code = personalCode.trim();
        if (!code) return setServerStatus("ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        setServerStatus("ë°ì´í„° í™•ì¸ ì¤‘...");
        try {
          const cb = `cb_${Date.now()}`;
          const res = await new Promise((resolve, reject) => {
            window[cb] = resolve;
            const script = document.createElement("script");
            script.src = `${CONFIG.SCRIPT_URL}?userKey=${encodeURIComponent(code)}&callback=${cb}&nocache=${Date.now()}`;
            script.onerror = () => reject(new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"));
            document.body.appendChild(script);
          });
          if (res.ok) {
            if (res.exists && res.data) {
              setStudentInfo({ school: res.data.school || "", gradeClass: res.data.gradeClass || "", name: res.data.name || "", major: res.data.major || "" });
              setSessionData(prev => ({ ...EMPTY_SESSION, ...res.data }));
              setServerStatus("âœ… ë¡œë“œ ì™„ë£Œ");
            } else {
              setServerStatus("ğŸ†• ì‹ ê·œ ê³„ì •");
              setStudentInfo({...EMPTY_STUDENT}); setSessionData({...EMPTY_SESSION});
            }
            setActiveUserKey(code); setIsLoggedIn(true);
          } else { setServerStatus("âš ï¸ ì˜¤ë¥˜: " + res.error); }
        } catch (e) { setServerStatus("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜"); console.error(e); }
      };

      const handleSaveAll = async () => {
        if (!isLoggedIn || !activeUserKey) return alert("ë¡œê·¸ì¸ í•„ìš”");
        setServerStatus("ì €ì¥ ì¤‘...");
        try {
          const res = await fetch(CONFIG.SCRIPT_URL, {
            method: "POST", headers: { "Content-Type": "text/plain; charset=utf-8" },
            body: JSON.stringify({ userKey: activeUserKey, ...studentInfo, ...sessionData })
          });
          const json = await res.json();
          if (json.ok) { 
            const delMsg = json.deleted > 0 ? ` (ì¤‘ë³µ ${json.deleted}ê±´ ì •ë¦¬ë¨)` : "";
            setServerStatus(`âœ… ì €ì¥ ì™„ë£Œ${delMsg}`); 
            setTimeout(() => setServerStatus(""), 3000); 
          }
          else throw new Error(json.error);
        } catch (e) { setServerStatus("âš ï¸ ì €ì¥ ì‹¤íŒ¨"); alert(e.message); }
      };

      const handleAskAI = async ({ promptText, systemText }) => {
        if (!promptText || !isLoggedIn) return alert("ì…ë ¥ í™•ì¸ ë° ë¡œê·¸ì¸ í•„ìš”");
        setAiLoading(true); setAiResult("");
        try {
          const res = await fetch(CONFIG.SCRIPT_URL, {
            method: "POST", headers: { "Content-Type": "text/plain; charset=utf-8" },
            body: JSON.stringify({ action: "askGemini", prompt: promptText, system: systemText, userKey: activeUserKey, model: CONFIG.GEMINI_MODEL })
          });
          const json = await res.json();
          if (json.ok) setAiResult(json.answer || "ì‘ë‹µ ì—†ìŒ"); else throw new Error(json.error);
        } catch(e) { setAiResult("ì˜¤ë¥˜: " + e.message); } finally { setAiLoading(false); }
      };

      const handleAiConsult = () => {
        const system = "ì…ì‹œ ì»¨ì„¤í„´íŠ¸ ì—­í• . í•µì‹¬ 3ê°€ì§€ ìš”ì•½. ëª…ì‚¬í˜• ì¢…ê²°.";
        let prompt = "";
        switch(activeTab) {
          case 1: prompt = `[ì „ê³µ:${studentInfo.major}] [ì£¼ì œ:${sessionData.s1_topic}] [ì§ˆë¬¸:${sessionData.s1_question}] í•™ìˆ ì  ì£¼ì œ/ì§ˆë¬¸ 3ê°€ì§€ ì œì•ˆ.`; break;
          case 2: prompt = `[ë„ì„œ:${sessionData.s2_book}] í•µì‹¬ í‚¤ì›Œë“œ 3ê°€ì§€.`; break;
          case 3: prompt = `[ë‚´ìš©:${sessionData.s3_depth}] êµê³¼ ê°œë… ì—°ê²° 3ë¬¸ì¥.`; break;
          case 4: prompt = `[ë°ì´í„°:${sessionData.s4_fact}] ì£¼ì¥-ê·¼ê±°-í•´ì„ 3ë¬¸ì¥.`; break;
          case 5: prompt = `[ìˆ˜í–‰:${sessionData.s5_log}] ë¬¸ì œí•´ê²° ì—­ëŸ‰ ìš”ì•½ 3ì¤„.`; break;
          case 8: prompt = `[ì£¼ì¥:${sessionData.s8_claim}] ì„¸íŠ¹ìš© 3ë¬¸ì¥ ìš”ì•½.`; break;
          default: prompt = "ì²´í¬ë¦¬ìŠ¤íŠ¸ 3ê°€ì§€.";
        }
        handleAskAI({ promptText: prompt, systemText: system });
      };

      const handleLogout = () => { setIsLoggedIn(false); setActiveUserKey(""); setPersonalCode(""); setStudentInfo({...EMPTY_STUDENT}); setSessionData({...EMPTY_SESSION}); setAiResult(""); setServerStatus(""); };
      const handleInput = (e) => setSessionData(prev => ({ ...prev, [e.target.name]: e.target.value }));
      const handleStudent = (e) => setStudentInfo(prev => ({ ...prev, [e.target.name]: e.target.value }));

      return (
        <div className="flex flex-col min-h-screen relative">
          {!isLoggedIn && <LoginScreen personalCode={personalCode} setPersonalCode={setPersonalCode} handleLogin={handleLogin} serverStatus={serverStatus} />}
          
          <div className="no-print flex-grow flex flex-col">
            <Header serverStatus={serverStatus} handleSaveAll={handleSaveAll} handleLogout={handleLogout} />
            <TabNavigation activeTab={activeTab} setActiveTab={setActiveTab} setAiResult={setAiResult} />
            
            <main className="flex-grow p-4 md:p-10 bg-slate-50">
              <div className="max-w-6xl mx-auto pb-32">
                <AiResultBox loading={aiLoading} result={aiResult} onClose={() => setAiResult("")} />
                <div className="bg-white rounded-[56px] border border-slate-200 shadow-sm p-8 md:p-16 min-h-[700px] flex flex-col">
                  <TabContent 
                    activeTab={activeTab} 
                    studentInfo={studentInfo} sessionData={sessionData}
                    handleStudent={handleStudent} handleInput={handleInput} 
                    handleAiConsult={handleAiConsult} aiLoading={aiLoading}
                  />
                </div>
              </div>
            </main>
          </div>
          
          <PrintView studentInfo={studentInfo} sessionData={sessionData} issueDate={issueDate} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
