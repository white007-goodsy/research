<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심화 탐구 통합 워크북</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@700;900&family=Noto+Sans+KR:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; }
        .serif { font-family: 'Noto Serif KR', serif; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // 구글 앱스 스크립트 주소 (선생님 주소 그대로 적용)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwozNNnGBT-iJtUzLAlalEJdEn_oEDMt3IIqNBwMHPuEQhmwvUi_x1-AbXDJoydCKcX/exec";

        const App = () => {
            const [personalCode, setPersonalCode] = useState("");
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [studentInfo, setStudentInfo] = useState({ school: "공주여자고등학교", gradeClass: "", name: "", major: "" });
            const [sessionData, setSessionData] = useState({ motive: "", question: "", book: "", log: "", summary: "" });

            useEffect(() => { 
                if (window.lucide) window.lucide.createIcons(); 
            }, [isLoggedIn]);

            // 입장 처리
            const handleLogin = async (e) => {
                e.preventDefault();
                if (!personalCode.trim()) return alert("코드를 입력하세요.");
                setIsLoading(true);
                try {
                    const res = await fetch(`${SCRIPT_URL}?userKey=${encodeURIComponent(personalCode)}`);
                    const json = await res.json();
                    if (json && json.name) {
                        setStudentInfo({ school: json.school, gradeClass: json.gradeClass, name: json.name, major: json.major });
                        setSessionData({ motive: json.motive, question: json.question, book: json.book, log: json.log, summary: json.summary });
                    }
                    setIsLoggedIn(true);
                } catch (err) {
                    console.error("데이터 로드 실패:", err);
                    setIsLoggedIn(true); // 에러가 나더라도 신규 사용자를 위해 입장은 허용
                }
                setIsLoading(false);
            };

            // 저장 처리
            const saveData = async () => {
                setIsLoading(true);
                try {
                    const payload = { userKey: personalCode, ...studentInfo, ...sessionData };
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    alert("구글 시트에 성공적으로 저장되었습니다!");
                } catch (err) {
                    alert("저장에 실패했습니다. 인터넷 연결을 확인하세요.");
                }
                setIsLoading(false);
            };

            // 1. 입장 전 화면
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6 text-center">
                        <div className="max-w-md w-full bg-white rounded-[40px] shadow-2xl p-10 border-t-[15px] border-emerald-800">
                            <h1 className="serif text-4xl font-black mb-10 text-slate-800 tracking-tighter">탐구 마스터 시스템</h1>
                            <form onSubmit={handleLogin} className="space-y-6">
                                <input 
                                    type="text" 
                                    value={personalCode} 
                                    onChange={(e) => setPersonalCode(e.target.value)} 
                                    placeholder="개인 코드를 입력하세요" 
                                    className="w-full p-6 rounded-3xl bg-slate-50 border-2 border-slate-100 text-center font-bold text-xl outline-none focus:border-emerald-600 transition-all shadow-inner" 
                                />
                                <button className="w-full bg-emerald-800 text-white p-6 rounded-3xl font-black text-lg shadow-lg hover:bg-emerald-900 transition-all flex items-center justify-center">
                                    {isLoading ? <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : "기록장 입장하기"}
                                </button>
                            </form>
                            <p className="mt-8 text-xs text-slate-400 font-bold uppercase tracking-widest italic">공주여자고등학교 이수연 선생님 제작</p>
                        </div>
                    </div>
                );
            }

            // 2. 입장 후 화면
            return (
                <div className="min-h-screen flex flex-col bg-slate-50">
                    <header className="no-print bg-white border-b px-8 py-5 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-4">
                            <h2 className="serif font-black text-2xl text-slate-800 italic tracking-tighter">학술 심화 탐구 기록장</h2>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={saveData} className="bg-emerald-700 text-white px-8 py-3 rounded-2xl text-xs font-black shadow-lg hover:bg-emerald-800 transition-all">
                                {isLoading ? "통신 중..." : "서버 저장"}
                            </button>
                            <button onClick={() => window.print()} className="bg-slate-900 text-white px-8 py-3 rounded-2xl text-xs font-black">인쇄</button>
                        </div>
                    </header>
                    <main className="no-print p-8 max-w-4xl mx-auto w-full">
                        <div className="bg-white rounded-[50px] shadow-xl p-12 min-h-[600px] border border-slate-100">
                            <div className="flex items-center justify-between border-b pb-6 mb-10">
                                <h3 className="serif text-3xl font-black text-slate-800 italic uppercase">Research Entry</h3>
                                <span className="text-[10px] font-black text-emerald-700 tracking-[0.3em] uppercase underline underline-offset-4 decoration-emerald-100">Academic Portal</span>
                            </div>
                            <textarea 
                                value={sessionData.motive}
                                onChange={(e) => setSessionData({...sessionData, motive: e.target.value})}
                                className="w-full h-[450px] p-10 rounded-[40px] bg-slate-50 border-none outline-none text-xl leading-relaxed shadow-inner placeholder:italic"
                                placeholder="탐구 내용 및 성찰을 자유롭게 기록하세요."
                            />
                        </div>
                    </main>
                    <footer className="no-print py-10 text-center border-t border-slate-100 font-bold serif text-slate-300 italic tracking-[0.5em] uppercase">
                        Gongju Girls' High School &middot; Lee Su-yeon
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
