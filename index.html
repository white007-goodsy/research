<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹¬í™” íƒêµ¬ í†µí•© ì›Œí¬ë¶ (ì™„ì „íŒ)</title>

  <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap');
    * { box-sizing: border-box; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f8fafc;
      color: #0f172a;
      word-break: keep-all;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }

    #loading-screen {
      position: fixed; inset: 0; background: #0f172a; color: white;
      display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;
      transition: opacity 0.5s ease;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media print {
      @page { size: A4; margin: 14mm; }

      .no-print { display: none !important; }
      .print-only { display: block !important; }

      html, body {
        background: #fff !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        font-family: "Noto Sans KR", system-ui, -apple-system, Segoe UI, Roboto, sans-serif !important;
        color: #111827 !important;
      }

      .print-root { width: 100%; }

      .print-page {
        page-break-after: always;
        break-after: page;
        padding: 0;
      }
      .print-page:last-child {
        page-break-after: auto;
        break-after: auto;
      }

      .avoid-break, .print-card, .print-block {
        break-inside: avoid;
        page-break-inside: avoid;
      }

      .shadow-xl, .shadow-2xl, .shadow-lg, .shadow-sm { box-shadow: none !important; }
      .border-double { border-style: solid !important; }

      .print-title { font-size: 26pt !important; line-height: 1.15 !important; font-weight: 900 !important; }
      .print-subtitle { font-size: 12pt !important; letter-spacing: 0.08em !important; color: #6b7280 !important; }
      .print-h2 { font-size: 16pt !important; font-weight: 900 !important; margin: 0 0 10mm 0 !important; }
      .print-label { font-size: 9pt !important; font-weight: 800 !important; letter-spacing: 0.12em !important; color: #6b7280 !important; text-transform: uppercase; }
      .print-body { font-size: 11pt !important; line-height: 1.55 !important; }
      .print-small { font-size: 9.5pt !important; line-height: 1.5 !important; color: #374151 !important; }

      ul, ol { margin: 0; padding-left: 18px; }
      li { margin: 2mm 0; }
    }
    .print-only { display: none; }

    .btn-ai-glow {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      transition: all 0.3s ease;
    }
    .btn-ai-glow:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.5);
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <div style="width:40px;height:40px;border:4px solid #6366f1;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:20px;"></div>
    <p style="font-weight:900;letter-spacing:2px;">SYSTEM LOADING...</p>
    <p style="font-size:12px;color:#94a3b8;margin-top:6px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
  </div>

  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const CONFIG = {
      SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxwuXwRhsb2f9XYd4b-XHTj6xgT865-orVv7IxiddjidgFUw9mINJsGydzhbKlkiVxp/exec",
      GEMINI_MODEL: "gemini-2.5-flash",
      APP_VERSION: "v6.5-FullRestored",
      LOCAL_PREFIX: "master_serverB_v6_full",
    };

    const EMPTY_STUDENT = { school: "", gradeClass: "", name: "", major: "" };
    const EMPTY_SESSION = {
      s1_topic: "", s1_motive: "", s1_question: "", s1_connection: "",
      s2_book: "", s2_author: "", s2_level: "ì „ê³µ ê¸°ì´ˆ(ê°œë¡ )", s2_part: "", s2_goal: "í•™ìˆ  ë³´ê³ ì„œ",
      s3_depth: "", s3_trace: "",
      s4_keyword: "", s4_fact: "",
      s5_log: "", s5_error: "", s5_result: "",
      s8_claim: "", s8_growth: "", s8_next: "", s8_summary: "",
    };

    const TABS = [
      { id: 0, title: "ì •ë³´ ì…ë ¥", icon: "user", color: "bg-slate-900" },
      { id: 11, title: "ìë£Œê²€ìƒ‰ ë¹„ë²•", icon: "search", color: "bg-amber-600" },
      { id: 1, title: "1ì°¨ì‹œ: ì£¼ì œ&ì§ˆë¬¸", icon: "clipboard-list", color: "bg-indigo-600" },
      { id: 2, title: "2ì°¨ì‹œ: ê³„íš", icon: "calendar", color: "bg-indigo-600" },
      { id: 3, title: "3ì°¨ì‹œ: ë„ì„œë¶„ì„", icon: "book-open", color: "bg-indigo-600" },
      { id: 4, title: "4ì°¨ì‹œ: ë…¼ë¬¸ë¶„ì„", icon: "file-text", color: "bg-indigo-600" },
      { id: 13, title: "íƒêµ¬ ë°©ë²•ë¡ ", icon: "bar-chart-3", color: "bg-indigo-600" },
      { id: 5, title: "5~7ì°¨ì‹œ: ìˆ˜í–‰", icon: "wand-2", color: "bg-indigo-600" },
      { id: 12, title: "AI ê°€ì´ë“œ", icon: "shield-check", color: "bg-rose-600" },
      { id: 8, title: "8~10ì°¨ì‹œ: ì„±ì°°", icon: "graduation-cap", color: "bg-indigo-600" },
    ];

    const Label = ({ children }) => (
      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 block mb-2">
        {children}
      </label>
    );

    const InputField = ({ label, name, value, onChange, placeholder, type = "text" }) => (
      <div className="space-y-2">
        {label && <Label>{label}</Label>}
        <input
          type={type} name={name} value={value} onChange={onChange} placeholder={placeholder}
          className="w-full p-6 rounded-3xl bg-slate-50 border-2 border-transparent focus:border-indigo-500 outline-none font-black text-xl transition-all shadow-sm"
        />
      </div>
    );

    const TextAreaField = ({ label, name, value, onChange, placeholder, height = "h-32", bgColor="bg-slate-50", textColor="text-slate-900" }) => (
      <div className="space-y-2">
        {label && <Label>{label}</Label>}
        <textarea
          name={name} value={value} onChange={onChange} placeholder={placeholder}
          className={`w-full ${height} p-6 rounded-[32px] ${bgColor} ${textColor} border-none outline-none font-medium text-base leading-relaxed resize-none shadow-inner`}
        />
      </div>
    );

    const LoginScreen = ({ personalCode, setPersonalCode, handleLogin, serverStatus }) => (
      <div className="fixed inset-0 z-[1000] bg-slate-900 flex items-center justify-center p-6">
        <div className="w-full max-w-md bg-white rounded-[48px] p-12 shadow-2xl fade-in text-center border border-white/20">
          <div className="mb-8 flex justify-center">
            <div className="bg-indigo-100 p-4 rounded-3xl text-indigo-600">
              <i data-lucide="key" className="w-8 h-8"></i>
            </div>
          </div>
          <h2 className="text-3xl font-black text-slate-900 tracking-tight">ê°œì¸ ì½”ë“œ ë¡œê·¸ì¸</h2>
          <p className="text-slate-500 mt-3 font-medium text-sm">ê¸°ì¡´ ì €ì¥ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜ ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</p>
          <input
            value={personalCode}
            onChange={e => setPersonalCode(e.target.value)}
            onKeyDown={e => e.key === "Enter" && handleLogin()}
            className="mt-10 w-full p-6 rounded-3xl bg-slate-100 border-2 border-transparent focus:border-indigo-500 outline-none font-black text-center text-2xl tracking-widest"
            placeholder="ì˜ˆ: 20101í™ê¸¸ë™"
          />
          {serverStatus && <p className="mt-4 text-xs font-bold text-indigo-600 bg-indigo-50 py-2 rounded-full">{serverStatus}</p>}
          <button
            onClick={handleLogin}
            className="mt-8 w-full bg-slate-900 text-white py-5 rounded-[24px] font-black text-lg shadow-xl active:scale-95 transition-all"
          >
            ì‹œìŠ¤í…œ ì ‘ì†
          </button>
        </div>
      </div>
    );

    const Header = ({ serverStatus, handleSaveAll, handleLogout }) => (
      <header className="bg-slate-900 text-white p-5 px-8 flex justify-between items-center sticky top-0 z-50 shadow-2xl">
        <div className="flex items-center gap-4">
          <div className="bg-indigo-500 p-2.5 rounded-2xl shadow-lg"><i data-lucide="zap" className="w-5 h-5"></i></div>
          <div>
            <h1 className="text-xl font-black tracking-tighter leading-none">ì‹¬í™” íƒêµ¬ í†µí•© ì›Œí¬ë¶</h1>
            <p className="text-slate-400 text-[9px] font-bold uppercase tracking-[0.3em] mt-1.5">v6.5 Full Restored</p>
          </div>
        </div>
        <div className="flex gap-2.5 items-center">
          {serverStatus && <span className="text-[10px] font-black bg-white/5 border border-white/10 px-4 py-2 rounded-xl">{serverStatus}</span>}
          <button onClick={handleSaveAll} className="bg-indigo-600 hover:bg-indigo-500 px-5 py-2.5 rounded-2xl text-xs font-black flex items-center gap-2 shadow-lg transition-all active:scale-95">
            <i data-lucide="save" className="w-3.5 h-3.5"></i> ì„œë²„ ì €ì¥
          </button>
          <button onClick={() => window.print()} className="bg-white/10 hover:bg-white/20 px-5 py-2.5 rounded-2xl text-xs font-black flex items-center gap-2 border border-white/5 active:scale-95 transition-all">
            <i data-lucide="printer" className="w-3.5 h-3.5"></i> ì¸ì‡„
          </button>
          <button onClick={handleLogout} className="bg-rose-600 hover:bg-rose-500 px-5 py-2.5 rounded-2xl text-xs font-black active:scale-95 transition-all">
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </header>
    );

    const TabNavigation = ({ activeTab, setActiveTab, setAiResult }) => (
      <nav className="bg-white border-b flex gap-1.5 overflow-x-auto p-3 px-6 scrollbar-hide sticky top-[76px] z-40 shadow-sm">
        {TABS.map(tab => (
          <button
            key={tab.id}
            onClick={() => { setActiveTab(tab.id); setAiResult(""); }}
            className={`flex-shrink-0 px-5 py-3 rounded-2xl border font-black text-[11px] flex items-center gap-2.5 transition-all ${
              activeTab === tab.id ? `${tab.color} text-white shadow-xl scale-105 ring-4 ring-indigo-50` : "bg-white text-slate-500 border-slate-100 hover:bg-slate-50"
            }`}
          >
            <i data-lucide={tab.icon} className="w-3.5 h-3.5"></i> {tab.title}
          </button>
        ))}
      </nav>
    );

    const AiResultBox = ({ loading, result, onClose }) => (
      (loading || result) ? (
        <div className="mb-10 bg-white border-2 border-indigo-100 rounded-[40px] p-10 shadow-2xl border-l-[16px] border-l-indigo-600 fade-in">
          <div className="flex items-center justify-between mb-6 pb-6 border-b">
            <div className="flex items-center gap-3 text-indigo-600 font-black text-lg"><i data-lucide="sparkles" className="w-6 h-6"></i> AI íŠœí„°ì˜ íƒêµ¬ ì •ë°€ ì§„ë‹¨</div>
            <button onClick={onClose} className="text-slate-300 hover:text-slate-900"><i data-lucide="x" className="w-6 h-6"></i></button>
          </div>
          {loading ? (
            <div className="flex flex-col items-center py-10">
              <div className="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-6"></div>
              <p className="text-base font-bold text-slate-500 tracking-tight">í•™ìƒì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ê°œì¡°ì‹ ì •ë¦¬ë¥¼ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
          ) : (
            <div className="text-base font-medium leading-relaxed whitespace-pre-wrap text-slate-800 bg-slate-50 p-8 rounded-3xl border border-slate-100 shadow-inner">{result}</div>
          )}
        </div>
      ) : null
    );

    const TabContent = ({ activeTab, studentInfo, sessionData, handleStudent, handleInput, handleAiConsult, aiLoading }) => {
      const SectionHeader = ({ title, subTitle, btnText, onBtnClick }) => (
        <div className="flex justify-between items-center border-b pb-8 mb-8">
          <div>
            <h2 className="text-4xl font-black text-slate-900 tracking-tighter">{title}</h2>
            {subTitle && <p className="text-slate-400 font-bold mt-1 text-xs uppercase">{subTitle}</p>}
          </div>
          {btnText && (
            <button onClick={onBtnClick} disabled={aiLoading} className="btn-ai-glow text-white px-8 py-4 rounded-3xl text-sm font-black flex items-center gap-2 active:scale-95 shadow-2xl">
              <i data-lucide="sparkles" className="w-5 h-5 text-amber-300"></i> {btnText}
            </button>
          )}
        </div>
      );

      switch(activeTab) {
        case 0: return (
          <div className="space-y-12 fade-in">
            <SectionHeader title="ì •ë³´ ì…ë ¥" subTitle="Personal Profile" />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <InputField label="í•™êµëª…" name="school" value={studentInfo.school} onChange={handleStudent} placeholder="OOê³ ë“±í•™êµ" />
              <InputField label="í•™ë²ˆ" name="gradeClass" value={studentInfo.gradeClass} onChange={handleStudent} placeholder="ì˜ˆ: 20101" />
              <InputField label="ì„±ëª…" name="name" value={studentInfo.name} onChange={handleStudent} placeholder="í™ê¸¸ë™" />
              <InputField label="í¬ë§ ì „ê³µ" name="major" value={studentInfo.major} onChange={handleStudent} placeholder="ì˜ˆ: ìƒëª…ê³µí•™" />
            </div>
            <div className="mt-10 p-8 bg-indigo-50/50 rounded-[32px] border border-indigo-100 italic font-bold text-indigo-800 text-sm">
              â€» ì…ë ¥ ì •ë³´ëŠ” ë¦¬í¬íŠ¸ì˜ í‘œì§€ ë° AI ë¶„ì„ ì‹œ ê¸°ì´ˆ ìë£Œë¡œ í™œìš©ë©ë‹ˆë‹¤.
            </div>
          </div>
        );
        case 11: return (
          <div className="space-y-10 fade-in">
            <h2 className="text-4xl font-black text-amber-600 flex items-center gap-4">
              <i data-lucide="search" className="w-10 h-10"></i> ìë£Œ ê²€ìƒ‰ ë¹„ë²• (R-Master)
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              <div className="bg-amber-50 p-8 rounded-[40px] border border-amber-100 shadow-sm">
                <h3 className="font-black text-amber-900 text-lg mb-4">â‘  í•™ìˆ DB í•„í„°ë§</h3>
                <ul className="text-sm text-amber-800 font-bold space-y-3">
                  <li>- DBpia/RISS ìµœê·¼ 3ë…„ ì´ë‚´ ë…¼ë¬¸</li>
                  <li>- 'KCI ë“±ì¬' ë…¼ë¬¸ ìš°ì„  í™•ì¸</li>
                  <li>- ì´ˆë¡(Abstract)ì˜ ê²°ê³¼ ìœ„ì£¼ í™•ì¸</li>
                </ul>
              </div>
              <div className="bg-indigo-50 p-8 rounded-[40px] border border-indigo-100 shadow-sm">
                <h3 className="font-black text-indigo-900 text-lg mb-4">â‘¡ ê³ ê¸‰ ê²€ìƒ‰ ë¬¸ë²•</h3>
                <ul className="text-sm text-indigo-800 font-bold space-y-3">
                  <li>- AND: ë‘ í‚¤ì›Œë“œ ëª¨ë‘ í¬í•¨</li>
                  <li>- OR: í•œ í‚¤ì›Œë“œë¼ë„ í¬í•¨</li>
                  <li>- " ": ì •í™•í•œ ë¬¸ì¥ ê²€ìƒ‰</li>
                </ul>
              </div>
              <div className="bg-slate-900 p-8 rounded-[40px] text-white shadow-xl">
                <h3 className="font-black text-indigo-400 text-lg mb-4">â‘¢ í†µê³„ ë° ì›ë°ì´í„°</h3>
                <ul className="text-sm font-bold space-y-3">
                  <li>- KOSIS êµ­ê°€í†µê³„í¬í„¸</li>
                  <li>- ê³µê³µë°ì´í„°í¬í„¸(data.go.kr)</li>
                  <li>- ê° ê¸°ê´€ ë³´ë„ìë£Œ í†µê³„</li>
                </ul>
              </div>
            </div>
          </div>
        );
        case 1: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="1ì°¨ì‹œ: ì£¼ì œ & ì§ˆë¬¸" subTitle="Research Topic & Question" btnText="AI ì£¼ì œ ì •êµí™”" onBtnClick={handleAiConsult} />
            <div className="space-y-10">
              <InputField label="íƒêµ¬ ì£¼ì œ (ê°€ì œ)" name="s1_topic" value={sessionData.s1_topic} onChange={handleInput} placeholder="ì˜ˆ: ì¬ìƒ ì—ë„ˆì§€ë¥¼ í™œìš©í•œ ì¹œí™˜ê²½ ë„ì‹œ ì„¤ê³„ ë°©ì•ˆ ì—°êµ¬" />
              <TextAreaField label="íƒêµ¬ ë™ê¸° ë° ê³„ê¸°" name="s1_motive" value={sessionData.s1_motive} onChange={handleInput} height="h-40" placeholder="ìˆ˜ì—… ì¤‘ ìƒê¸´ ê¶ê¸ˆì¦ì´ë‚˜ ì‚¬íšŒì  ì‚¬ê±´ ë“± êµ¬ì²´ì ì¸ ë™ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”." />
              <InputField label="í•µì‹¬ íƒêµ¬ ì§ˆë¬¸ (RQ)" name="s1_question" value={sessionData.s1_question} onChange={handleInput} placeholder="ì˜ˆ: ì–´ë–¤ ë³€ì¸ì´ ê²°ê³¼ì— ê°€ì¥ í° ì˜í–¥ì„ ë¯¸ì¹˜ëŠ”ê°€?" />
              <TextAreaField label="êµê³¼/ì „ê³µ ì—°ê²° ê³ ë¦¬" name="s1_connection" value={sessionData.s1_connection} onChange={handleInput} placeholder="êµê³¼ì„œì˜ ì–´ë–¤ ì›ë¦¬ê°€ ì „ê³µì˜ ì–´ë–¤ ê°œë…ê³¼ ì—°ê²°ë˜ë‚˜ìš”?" />
            </div>
          </div>
        );
        case 2: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="2ì°¨ì‹œ: ë„ì„œ ë° íƒêµ¬ ê³„íš" btnText="AI í‚¤ì›Œë“œ ì¶”ì¶œ" onBtnClick={handleAiConsult} />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
              <InputField label="ì‹¬í™” ë„ì„œëª…" name="s2_book" value={sessionData.s2_book} onChange={handleInput} placeholder="ì±… ì œëª©" />
              <InputField label="ì €ì" name="s2_author" value={sessionData.s2_author} onChange={handleInput} placeholder="ì €ìëª…" />
              <div className="space-y-4">
                <Label>ë„ì„œ ë‚œì´ë„</Label>
                <select name="s2_level" value={sessionData.s2_level} onChange={handleInput} className="w-full p-6 rounded-3xl bg-slate-50 font-black text-lg appearance-none outline-none focus:ring-4 focus:ring-indigo-100">
                  <option>ì „ê³µ ê¸°ì´ˆ(ê°œë¡ )</option><option>ì „ë¬¸ í•™ìˆ ì„œ</option><option>êµì–‘ì„œ</option><option>ì›ì „/ê³ ì „</option>
                </select>
              </div>
              <div className="space-y-4">
                <Label>ìµœì¢… ì‚°ì¶œë¬¼ ëª©í‘œ</Label>
                <select name="s2_goal" value={sessionData.s2_goal} onChange={handleInput} className="w-full p-6 rounded-3xl bg-slate-50 font-black text-lg appearance-none outline-none focus:ring-4 focus:ring-indigo-100">
                  <option>í•™ìˆ  ë³´ê³ ì„œ</option><option>ë°ì´í„° ë¦¬í¬íŠ¸</option><option>ì‹¤í—˜ ë³´ê³ ì„œ</option><option>ì •ì±… ì œì•ˆì„œ</option>
                </select>
              </div>
            </div>
            <InputField label="ì§‘ì¤‘ íƒë… ì§€ì  (ë°œì·Œë… ì±•í„°)" name="s2_part" value={sessionData.s2_part} onChange={handleInput} placeholder="ì˜ˆ: ì œ3ì¥ ë°ì´í„° ë¦¬í„°ëŸ¬ì‹œì˜ ì‹¤ì œì  ì ìš© ì‚¬ë¡€" />
          </div>
        );
        case 3: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="3ì°¨ì‹œ: ë„ì„œ ì‹¬í™” ë¶„ì„" btnText="ì§€ì‹ ì •êµí™” ì½”ì¹­" onBtnClick={handleAiConsult} />
            <TextAreaField label="êµê³¼ì„œ ë„ˆë¨¸ì˜ ì§€ì‹ (Depth Analysis)" name="s3_depth" value={sessionData.s3_depth} onChange={handleInput} height="h-80" placeholder="ë„ì„œë¥¼ í†µí•´ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ í•™ìˆ ì  ì›ë¦¬ë¥¼ ìƒì„¸íˆ ì •ë¦¬í•˜ì„¸ìš”." />
            <InputField label="ì¶”ê°€ ìë£Œ ì¶”ì " name="s3_trace" value={sessionData.s3_trace} onChange={handleInput} placeholder="ì±…ì—ì„œ ì–¸ê¸‰ëœ ë…¼ë¬¸ì´ë‚˜ ë‹¤ë¥¸ ë„ì„œ ë¦¬ìŠ¤íŠ¸" />
          </div>
        );
        case 4: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="4ì°¨ì‹œ: ë…¼ë¬¸ ë°ì´í„° ë¶„ì„" subTitle="Scholarly Evidence & Facts" btnText="AI ì£¼ê·¼ì„¤ ë¬¸ì¥ ìƒì„±" onBtnClick={handleAiConsult} />
            <TextAreaField label="ìµœì‹  í•™ìˆ  íŠ¸ë Œë“œ/í‚¤ì›Œë“œ" name="s4_keyword" value={sessionData.s4_keyword} onChange={handleInput} placeholder="ë…¼ë¬¸ë“¤ì—ì„œ ê³µí†µì ìœ¼ë¡œ ë‹¤ë£¨ëŠ” í•µì‹¬ ë¬¸ì œì˜ì‹" />
            <TextAreaField label="í•µì‹¬ ìˆ«ìì™€ íŒ©íŠ¸ (Core Evidence)" name="s4_fact" value={sessionData.s4_fact} onChange={handleInput} height="h-64" bgColor="bg-indigo-50/30" textColor="text-indigo-900" placeholder="ë³´ê³ ì„œì˜ ê·¼ê±°ê°€ ë  í†µê³„ ìˆ˜ì¹˜, ì‹¤í—˜ ê²°ê³¼, í‘œì˜ ë°ì´í„° ë“±ì„ ì¶œì²˜ì™€ í•¨ê»˜ ê¸°ë¡í•˜ì„¸ìš”." />
          </div>
        );
        case 13: return (
          <div className="space-y-12 fade-in">
            <h2 className="text-4xl font-black text-indigo-600 tracking-tighter">ğŸ“Š íƒêµ¬ ë°©ë²•ë¡  ë§ˆìŠ¤í„° ê°€ì´ë“œ</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-indigo-50 p-10 rounded-[48px] border-2 border-indigo-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="database" className="w-20 h-20"></i></div>
                <h3 className="font-black text-indigo-900 text-2xl mb-4">â‘  ë°ì´í„° ì¬í•´ì„í˜•</h3>
                <p className="text-sm text-indigo-800 leading-relaxed font-bold">ê³µê³µë°ì´í„°ë‚˜ í†µê³„ ìˆ˜ì¹˜ë¥¼ ìƒˆë¡œìš´ ê°€ì„¤ë¡œ ì—°ê²°í•˜ì—¬ ì‹œê°í™”í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.</p>
              </div>
              <div className="bg-emerald-50 p-10 rounded-[48px] border-2 border-emerald-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="shuffle" className="w-20 h-20"></i></div>
                <h3 className="font-black text-emerald-900 text-2xl mb-4">â‘¡ ì‚¬ë¡€ ë¹„êµí˜•</h3>
                <p className="text-sm text-emerald-800 leading-relaxed font-bold">ë™ì¼í•œ ë³€ì¸ì„ ê°€ì§„ ë‹¤ë¥¸ ì‚¬ë¡€ Aì™€ Bë¥¼ ëŒ€ì¡°í•˜ì—¬ ì°¨ì´ì˜ ì›ì¸ì„ íƒêµ¬í•©ë‹ˆë‹¤.</p>
              </div>
              <div className="bg-rose-50 p-10 rounded-[48px] border-2 border-rose-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="test-tube" className="w-20 h-20"></i></div>
                <h3 className="font-black text-rose-900 text-2xl mb-4">â‘¢ ê°€ì„¤ ì‹¤í—˜í˜•</h3>
                <p className="text-sm text-rose-800 leading-relaxed font-bold">íŠ¹ì • ë³€ì¸ì„ í†µì œí•œ ìƒíƒœì—ì„œ ì‹¤í—˜ì„ ìˆ˜í–‰í•˜ê³  ì˜ˆì¸¡ê°’ê³¼ ì‹¤ì œê°’ì„ ë¹„êµí•©ë‹ˆë‹¤.</p>
              </div>
              <div className="bg-amber-50 p-10 rounded-[48px] border-2 border-amber-100 shadow-sm relative overflow-hidden group">
                <div className="absolute top-0 right-0 p-6 opacity-10 group-hover:scale-110 transition-transform"><i data-lucide="pen-tool" className="w-20 h-20"></i></div>
                <h3 className="font-black text-amber-900 text-2xl mb-4">â‘£ ì´ë¡  ì ìš©í˜•</h3>
                <p className="text-sm text-amber-800 leading-relaxed font-bold">ì¶”ìƒì ì¸ ì „ê³µ ì´ë¡ ì„ ì‹¤ì œ ì‚¬íšŒ í˜„ìƒì´ë‚˜ ê¸°ì—… ì‚¬ë¡€ì— ëŒ€ì…í•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.</p>
              </div>
            </div>
            <div className="bg-slate-900 p-10 rounded-[48px] text-white shadow-2xl">
              <h3 className="font-black text-indigo-400 text-xl mb-4 tracking-tighter">ğŸ’¡ ì£¼ê·¼ì„¤ ë¬¸ì¥ ê³µì‹</h3>
              <p className="text-lg leading-relaxed font-bold italic">"[ìë£Œì¶œì²˜/ì—°ë„]ì— ì˜í•˜ë©´ [A] ì§€í‘œê°€ [N] ìˆ˜ì¹˜ë¡œ ë‚˜íƒ€ë‚¨. ì´ëŠ” [í•™ìŠµí•œ ì›ë¦¬]ì— ë¹„ì¶”ì–´ ë³¼ ë•Œ [í•´ì„/ë¶„ì„]ìœ¼ë¡œ íŒë‹¨í•  ìˆ˜ ìˆìŒ."</p>
            </div>
          </div>
        );
        case 5: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="5~7ì°¨ì‹œ: ìˆ˜í–‰ ë° ë…¸ë ¥ ê¸°ë¡" subTitle="Action Log & Failure Record" btnText="ìˆ˜í–‰ ì½”ì¹­ ìš”ì²­" onBtnClick={handleAiConsult} />
            <TextAreaField label="ì§„ì§œ ë…¸ë ¥ ì¼ì§€ (Action Log)" name="s5_log" value={sessionData.s5_log} onChange={handleInput} height="h-48" placeholder="ë°©ë¬¸ ì‚¬ì´íŠ¸, ë°ì´í„° ê°€ê³µ ê³¼ì •, ì°¸ê³ í•œ ìˆ˜ì‹ ë“± êµ¬ì²´ì ì¸ í–‰ìœ„ë¥¼ ë‚ ì§œë³„ë¡œ ê¸°ë¡í•˜ì„¸ìš”." />
            <TextAreaField label="ì‹œí–‰ì°©ì˜¤ ë° ì‹¤íŒ¨ ê¸°ë¡ (Error Log)" name="s5_error" value={sessionData.s5_error} onChange={handleInput} height="h-32" bgColor="bg-rose-50/50" textColor="text-rose-900 italic" placeholder="ìë£Œê°€ ì—†ì–´ì„œ ì‹¤íŒ¨í–ˆê±°ë‚˜ ê°€ì„¤ì´ í‹€ë ¸ë˜ ì§€ì  ë“± ì‹¤íŒ¨ì˜ í”ì ì„ ì†”ì§íˆ ì ìœ¼ì„¸ìš”." />
            <TextAreaField label="ì¤‘ê°„ ì‚°ì¶œë¬¼ (Interim Result)" name="s5_result" value={sessionData.s5_result} onChange={handleInput} height="h-32" bgColor="bg-emerald-50/50" textColor="text-emerald-900" placeholder="ë„ì¶œëœ í‘œ, ê·¸ë˜í”„ì˜ ìˆ˜ì¹˜ë‚˜ í•µì‹¬ ì¤‘ê°„ ê²°ë¡ ì„ ì ìœ¼ì„¸ìš”." />
          </div>
        );
        case 12: return (
          <div className="space-y-12 fade-in text-center py-16">
            <div className="bg-rose-50 p-16 rounded-[80px] border-4 border-rose-100 max-w-3xl mx-auto shadow-2xl">
              <i data-lucide="alert-triangle" className="w-20 h-20 text-rose-500 mx-auto mb-8"></i>
              <h2 className="text-4xl font-black text-rose-900 tracking-tighter mb-6">AIëŠ” ë°œí’ˆì„ ëŒ€ì‹  íŒ”ì§€ ì•ŠìŠµë‹ˆë‹¤.</h2>
              <p className="text-xl text-rose-800 leading-relaxed font-bold mb-10 italic">
                ì‚¬ì •ê´€ì€ ë§¤ë„ëŸ¬ìš´ AI ë¬¸ì¥ë³´ë‹¤<br />ì—¬ëŸ¬ë¶„ì˜ ê±°ì¹ ê³  íˆ¬ë°•í•œ 'ì‹œí–‰ì°©ì˜¤ ê¸°ë¡'ì„ ë” ì‹ ë¢°í•©ë‹ˆë‹¤.
              </p>
              <div className="text-left bg-white/60 p-10 rounded-[40px] space-y-6 font-bold text-base text-rose-950 border border-rose-200 shadow-inner">
                <p className="flex gap-4"><i data-lucide="check-circle" className="w-6 h-6 shrink-0 text-rose-600"></i> AIëŠ” ë…¼ë¦¬ êµ¬ì¡°ë¥¼ ì¡ëŠ” ë³´ì¡° ë„êµ¬ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.</p>
                <p className="flex gap-4"><i data-lucide="check-circle" className="w-6 h-6 shrink-0 text-rose-600"></i> ë°˜ë“œì‹œ ì§ì ‘ ì°¾ì€ 'ìˆ«ì'ì™€ 'ë°ì´í„°'ë¥¼ í”„ë¡¬í”„íŠ¸ì— ë„£ìœ¼ì„¸ìš”.</p>
                <p className="flex gap-4"><i data-lucide="check-circle" className="w-6 h-6 shrink-0 text-rose-600"></i> ë§¤ë„ëŸ½ê²Œ ìˆ˜ì •í•´ë‹¬ë¼ëŠ” ìš”ì²­ë³´ë‹¤, ë…¼ë¦¬ì˜ í—ˆì ì„ ì°¾ì•„ë‹¬ë¼ê³  í•˜ì„¸ìš”.</p>
              </div>
            </div>
          </div>
        );
        case 8: return (
          <div className="fade-in space-y-10">
            <SectionHeader title="8~10ì°¨ì‹œ: ì„±ì°° ë° ìµœì¢… ìš”ì•½" subTitle="Synthesis & Final Portfolio" btnText="AI ì„¸íŠ¹ ì´ˆì•ˆ ì™„ì„±" onBtnClick={handleAiConsult} />
            <TextAreaField label="ìµœì¢… ì£¼ì¥ (Final Claim)" name="s8_claim" value={sessionData.s8_claim} onChange={handleInput} height="h-32" placeholder="íƒêµ¬ ê²°ê³¼ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ì •ì˜í•œë‹¤ë©´?" />
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <TextAreaField label="ì„±ì¥ ë° ë°°ìš´ ì " name="s8_growth" value={sessionData.s8_growth} onChange={handleInput} height="h-40" placeholder="ê°œë…/ê¸°ìˆ /íƒœë„ ì¸¡ë©´ì—ì„œì˜ ë³€í™”" />
              <TextAreaField label="í›„ì† íƒêµ¬ ì œì–¸" name="s8_next" value={sessionData.s8_next} onChange={handleInput} height="h-40" placeholder="í•œê³„ì ê³¼ ë‹¤ìŒ ì—°êµ¬ ë°©í–¥" />
            </div>
            <div className="p-12 bg-slate-900 text-white rounded-[64px] shadow-2xl relative overflow-hidden">
              <div className="absolute top-0 right-0 p-10 opacity-10"><i data-lucide="graduation-cap" className="w-40 h-40 text-indigo-400"></i></div>
              <Label><span className="text-indigo-400">ğŸ“ ìƒí™œê¸°ë¡ë¶€ ìš”ì•½ë³¸ (FINAL SUMMARY)</span></Label>
              <textarea name="s8_summary" value={sessionData.s8_summary} onChange={handleInput} className="w-full h-72 bg-transparent border-none outline-none text-xl font-black leading-relaxed mt-6 resize-none scrollbar-hide relative z-10" placeholder="[ë™ê¸°-ê³¼ì •-ì„±ì¥-í›„ì†] êµ¬ì¡°ë¡œ 10ì°¨ì‹œ ì—¬ì •ì„ 500ì ì´ë‚´ë¡œ ì™„ê²°í•˜ì„¸ìš”." />
            </div>
          </div>
        );
        default: return <div className="p-10 text-center font-bold text-slate-400">ì„ íƒëœ íƒ­ì˜ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</div>;
      }
    };

    const PrintView = ({ studentInfo, sessionData, issueDate }) => (
      <div className="print-only print-root">
        <section className="print-page">
          <div className="avoid-break">
            <div className="print-label">Research Workbook</div>
            <h1 className="print-title">ì‹¬í™” íƒêµ¬ í†µí•© ì›Œí¬ë¶</h1>
            <div className="print-subtitle">Comprehensive Research Workbook</div>
          </div>

          <div style={{ height: "10mm" }} />

          <div className="print-card avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "10mm", padding: "8mm" }}>
            <div className="print-label">Student</div>
            <div className="print-body" style={{ marginTop: "2mm" }}>
              <div><b>í•™êµ</b>: {studentInfo.school || "ë¯¸ì…ë ¥"}</div>
              <div><b>í•™ë²ˆ/ë°˜</b>: {studentInfo.gradeClass || "ë¯¸ì…ë ¥"}</div>
              <div><b>ì´ë¦„</b>: {studentInfo.name || "ë¯¸ì…ë ¥"}</div>
              <div><b>í¬ë§ ì „ê³µ</b>: {studentInfo.major || "ë¯¸ì…ë ¥"}</div>
              <div><b>ë°œê¸‰ì¼</b>: {issueDate}</div>
            </div>
          </div>
        </section>

        <section className="print-page">
          <h2 className="print-h2">01. íƒêµ¬ ì„¤ê³„ ë° ë°°ê²½</h2>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm", marginBottom: "6mm" }}>
            <div className="print-label">Topic</div>
            <div className="print-body" style={{ marginTop: "2mm", fontWeight: 800 }}>
              {sessionData.s1_topic || "ì…ë ¥ëœ íƒêµ¬ ì£¼ì œê°€ ì—†ìŠµë‹ˆë‹¤."}
            </div>
          </div>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm", marginBottom: "6mm" }}>
            <div className="print-label">Core Question</div>
            <div className="print-body" style={{ marginTop: "2mm" }}>
              {sessionData.s1_question || "ì…ë ¥ëœ íƒêµ¬ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."}
            </div>
          </div>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm" }}>
            <div className="print-label">Motivation & Connection</div>
            <div className="print-small" style={{ marginTop: "2mm", whiteSpace: "pre-wrap" }}>
              {sessionData.s1_motive || ""}
              {"\n\n"}
              {sessionData.s1_connection || ""}
            </div>
          </div>
        </section>

        <section className="print-page">
          <h2 className="print-h2">02. ë°ì´í„° ë¶„ì„ ë° ìˆ˜í–‰ ê³¼ì •</h2>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm", marginBottom: "6mm" }}>
            <div className="print-label">Core Evidence</div>
            <div className="print-small" style={{ marginTop: "2mm", whiteSpace: "pre-wrap" }}>
              {sessionData.s4_fact || ""}
            </div>
          </div>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm", marginBottom: "6mm" }}>
            <div className="print-label">Action Log</div>
            <div className="print-small" style={{ marginTop: "2mm", whiteSpace: "pre-wrap" }}>
              {sessionData.s5_log || ""}
            </div>
          </div>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm" }}>
            <div className="print-label">Error / Failure</div>
            <div className="print-small" style={{ marginTop: "2mm", whiteSpace: "pre-wrap" }}>
              {sessionData.s5_error || ""}
            </div>
          </div>
        </section>

        <section className="print-page">
          <h2 className="print-h2">03. ìµœì¢… ì„±ì°° ë° ìš”ì•½</h2>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm", marginBottom: "6mm" }}>
            <div className="print-label">Final Claim</div>
            <div className="print-body" style={{ marginTop: "2mm", whiteSpace: "pre-wrap", fontWeight: 800 }}>
              {sessionData.s8_claim || ""}
            </div>
          </div>

          <div className="print-block avoid-break" style={{ border: "1px solid #e5e7eb", borderRadius: "8mm", padding: "7mm", marginBottom: "6mm" }}>
            <div className="print-label">Growth & Next</div>
            <div className="print-small" style={{ marginTop: "2mm", whiteSpace: "pre-wrap" }}>
              {sessionData.s8_growth || ""}
              {"\n\n"}
              {sessionData.s8_next || ""}
            </div>
          </div>

          <div className="print-block avoid-break" style={{ border: "1px solid #111827", borderRadius: "8mm", padding: "7mm" }}>
            <div className="print-label">ìƒí™œê¸°ë¡ë¶€ ìš”ì•½</div>
            <div className="print-body" style={{ marginTop: "2mm", whiteSpace: "pre-wrap" }}>
              {sessionData.s8_summary || "ìš”ì•½ë³¸ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}
            </div>
          </div>
        </section>
      </div>
    );

    const App = () => {
      const [personalCode, setPersonalCode] = useState("");
      const [activeUserKey, setActiveUserKey] = useState("");
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [serverStatus, setServerStatus] = useState("");
      const [studentInfo, setStudentInfo] = useState({ ...EMPTY_STUDENT });
      const [sessionData, setSessionData] = useState({ ...EMPTY_SESSION });
      const [activeTab, setActiveTab] = useState(0);
      const [aiLoading, setAiLoading] = useState(false);
      const [aiResult, setAiResult] = useState("");
      const [issueDate] = useState(() => new Date().toLocaleDateString());

      const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };

      useEffect(() => {
        const timer = setTimeout(() => {
          const loader = document.getElementById("loading-screen");
          if (loader) {
            loader.style.opacity = "0";
            setTimeout(() => { loader.style.display = "none"; }, 500);
          }
          refreshIcons();
        }, 800);
        return () => clearTimeout(timer);
      }, []);

      useEffect(() => { setTimeout(refreshIcons, 100); }, [activeTab, aiResult, isLoggedIn]);

      const handleLogin = async () => {
        const code = personalCode.trim();
        if (!code) return setServerStatus("ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        setServerStatus("ë°ì´í„° í™•ì¸ ì¤‘...");

        const cb = `cb_${Date.now()}`;
        let script = null;

        try {
          const res = await new Promise((resolve, reject) => {
            window[cb] = (data) => resolve(data);

            script = document.createElement("script");
            script.src = `${CONFIG.SCRIPT_URL}?userKey=${encodeURIComponent(code)}&callback=${cb}&nocache=${Date.now()}`;
            script.onload = () => {};
            script.onerror = () => reject(new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"));
            document.body.appendChild(script);
          });

          if (res.ok) {
            if (res.exists && res.data) {
              setStudentInfo({
                school: res.data.school || "",
                gradeClass: res.data.gradeClass || "",
                name: res.data.name || "",
                major: res.data.major || ""
              });

              const nextSession = { ...EMPTY_SESSION };
              Object.keys(EMPTY_SESSION).forEach((k) => {
                if (res.data && Object.prototype.hasOwnProperty.call(res.data, k)) {
                  nextSession[k] = res.data[k] ?? "";
                }
              });
              setSessionData(nextSession);

              setServerStatus("âœ… ë¡œë“œ ì™„ë£Œ");
            } else {
              setServerStatus("ğŸ†• ì‹ ê·œ ê³„ì •");
              setStudentInfo({ ...EMPTY_STUDENT });
              setSessionData({ ...EMPTY_SESSION });
            }
            setActiveUserKey(code);
            setIsLoggedIn(true);
          } else {
            setServerStatus("âš ï¸ ì˜¤ë¥˜: " + (res.error || ""));
          }
        } catch (e) {
          setServerStatus("âš ï¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
          console.error(e);
        } finally {
          // cleanup
          try { if (script) script.remove(); } catch(_) {}
          try { delete window[cb]; } catch(_) {}
        }
      };

      const handleSaveAll = async () => {
        if (!isLoggedIn || !activeUserKey) return alert("ë¡œê·¸ì¸ í•„ìš”");
        setServerStatus("ì €ì¥ ì¤‘...");

        try {
          // sessionData ë¨¼ì €, studentInfoë¥¼ ë§ˆì§€ë§‰ì— (ë®ì–´ì“°ê¸° ì•ˆì „)
          const payload = { userKey: activeUserKey, ...sessionData, ...studentInfo };

          const res = await fetch(CONFIG.SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain; charset=utf-8" },
            body: JSON.stringify(payload)
          });

          const text = await res.text();
          let json;
          try { json = JSON.parse(text); }
          catch (_) {
            throw new Error("ì„œë²„ ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤.\n\nì‘ë‹µ ì¼ë¶€:\n" + text.slice(0, 300));
          }

          if (json.ok) {
            const act = json.action === "updated" ? "ìˆ˜ì •" : "ì‹ ê·œì €ì¥";
            setServerStatus(`âœ… ${act} ì™„ë£Œ (${json.timestamp || ""})`);
            setTimeout(() => setServerStatus(""), 3000);
          } else {
            throw new Error(json.error || "ì €ì¥ ì‹¤íŒ¨");
          }

        } catch (e) {
          setServerStatus("âš ï¸ ì €ì¥ ì‹¤íŒ¨");
          alert(e.message);
        }
      };

      const handleAskAI = async ({ promptText, systemText }) => {
        if (!promptText || !isLoggedIn) return alert("ì…ë ¥ í™•ì¸ ë° ë¡œê·¸ì¸ í•„ìš”");
        setAiLoading(true); setAiResult("");

        try {
          const res = await fetch(CONFIG.SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain; charset=utf-8" },
            body: JSON.stringify({
              action: "askGemini",
              prompt: promptText,
              system: systemText,
              userKey: activeUserKey,
              model: CONFIG.GEMINI_MODEL
            })
          });

          const text = await res.text();
          let json;
          try { json = JSON.parse(text); }
          catch (_) { throw new Error("AI ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤:\n" + text.slice(0, 300)); }

          if (json.ok) setAiResult(json.answer || "ì‘ë‹µ ì—†ìŒ");
          else throw new Error(json.error || "AI ì‹¤íŒ¨");

        } catch(e) {
          setAiResult("ì˜¤ë¥˜: " + e.message);
        } finally {
          setAiLoading(false);
        }
      };

      // âœ… [FIX] handleAiConsult ë‹¨ì¼ ì„ ì–¸ + ê°œì¡°ì‹ í”„ë¡¬í”„íŠ¸
      const handleAiConsult = () => {
        const system = [
          "ì—­í• : ê³ ë“±í•™êµ í•™ìƒìš© íƒêµ¬ ì½”ì¹˜.",
          "ëª©í‘œ: í•™ìƒ ì…ë ¥ì„ 'ê°œì¡°ì‹'ìœ¼ë¡œ ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì •ë¦¬/ê°œì„ .",
          "",
          "[ì¶œë ¥ í˜•ì‹ ê³ ì •]",
          "- ë°˜ë“œì‹œ ë²ˆí˜¸ ê°œì¡°ì‹: (1) (2) (3) ...",
          "- ê° í•­ëª© 1~2ë¬¸ì¥, í•œ í•­ëª© 80ì ë‚´ì™¸ ê¶Œì¥.",
          "- ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ ì‚­ì œ, í•µì‹¬ì–´ë¥¼ ë¬¸ì¥ ì•ì— ë°°ì¹˜.",
          "- í•™ìƒì´ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ë„ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥.",
          "- ì…ë ¥ì´ ë¶€ì¡±í•˜ë©´ ë§ˆì§€ë§‰ì— 'ì¶”ê°€ë¡œ ì ì„ ê²ƒ(ì§ˆë¬¸ 3ê°œ)'.",
          "- ê³¼ì¥/í—ˆìœ„ ê¸ˆì§€. ì…ë ¥ì—ì„œ ë²—ì–´ë‚œ ì‚¬ì‹¤ ìƒì„± ê¸ˆì§€.",
          "- ë¬¸ì¥ ì¢…ê²°ì€ '~í•©ë‹ˆë‹¤'ë¡œ í†µì¼."
        ].join("\n");

        let prompt = "";

        switch(activeTab) {
          case 1:
            prompt = `
[ì „ê³µ] ${studentInfo.major}
[íƒêµ¬ ì£¼ì œ(ê°€ì œ)] ${sessionData.s1_topic}
[ë™ê¸°] ${sessionData.s1_motive}
[í•µì‹¬ ì§ˆë¬¸(RQ)] ${sessionData.s1_question}
[êµê³¼/ì „ê³µ ì—°ê²°] ${sessionData.s1_connection}

ìœ„ ë‚´ìš©ì„ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ê°œì¡°ì‹ìœ¼ë¡œ ë‹¤ì‹œ ì‘ì„±í•©ë‹ˆë‹¤.
(1) ì£¼ì œ: í•œ ì¤„ ì •ì˜í•©ë‹ˆë‹¤.
(2) ë™ê¸°: ì‚¬ê±´/ê²½í—˜/ë¬¸ì œì˜ì‹ ì¤‘ì‹¬ 2ì¤„ë¡œ ì”ë‹ˆë‹¤.
(3) ì—°êµ¬ì§ˆë¬¸: RQ 1ê°œ + í•˜ìœ„ì§ˆë¬¸ 2ê°œë¥¼ ì”ë‹ˆë‹¤.
(4) ì—°ê²° í‚¤ì›Œë“œ: êµê³¼ ê°œë…/ì „ê³µ ê°œë… í‚¤ì›Œë“œ 3ê°œë¥¼ ì”ë‹ˆë‹¤.
(5) ë²”ìœ„/ëŒ€ìƒ/ë³€ì¸: ìˆìœ¼ë©´ 3ì¤„ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
- ê° í•­ëª©ì€ "[í•µì‹¬ì–´] ë‚´ìš©" í˜•íƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
`.trim();
            break;

          case 2:
            prompt = `
[ë„ì„œ] ${sessionData.s2_book}
[ì €ì] ${sessionData.s2_author}
[ë‚œì´ë„] ${sessionData.s2_level}
[ì§‘ì¤‘ ì±•í„°/ë¶€ë¶„] ${sessionData.s2_part}
[ìµœì¢… ì‚°ì¶œë¬¼] ${sessionData.s2_goal}

ìœ„ ê³„íšì„ í•™ìƒìš© ê°œì¡°ì‹ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
(1) ì„ íƒ ì´ìœ : ì „ê³µ/ì£¼ì œ ì—°ê²° ì¤‘ì‹¬ìœ¼ë¡œ 2ì¤„ë¡œ ì”ë‹ˆë‹¤.
(2) ì½ì„ ë²”ìœ„: ì±•í„°/íŒŒíŠ¸ì™€ ì´ìœ ë¥¼ 3ì¤„ë¡œ ì”ë‹ˆë‹¤.
(3) í•µì‹¬ ê°œë…: 5ê°œë¥¼ "í‚¤ì›Œë“œ: í•œ ì¤„ ì„¤ëª…"ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(4) ì‚°ì¶œë¬¼ ëª©ì°¨: 5ê°œ í•­ëª©ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(5) ë‹¤ìŒ ì°¨ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸: 6ê°œë¡œ ì”ë‹ˆë‹¤.
- ê° í•­ëª©ì€ "[í•µì‹¬ì–´] ë‚´ìš©" í˜•íƒœë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
`.trim();
            break;

          case 3:
            prompt = `
[ë„ì„œë¡œ ì–»ì€ ì§€ì‹] ${sessionData.s3_depth}
[ì¶”ê°€ ìë£Œ ì¶”ì ] ${sessionData.s3_trace}

ìœ„ ë‚´ìš©ì„ ê°œì¡°ì‹ìœ¼ë¡œ ì¬ì‘ì„±í•©ë‹ˆë‹¤.
(1) í•µì‹¬ ê°œë… 5ê°œ: "ê°œë…: í•œ ì¤„ ì •ì˜"ë¡œ ì”ë‹ˆë‹¤.
(2) ê°œë… ì—°ê²° 3ê°œ: ì›ì¸-ê²°ê³¼/ë¹„êµ/êµ¬ì¡°ë¡œ ì”ë‹ˆë‹¤.
(3) êµê³¼ì„œ ì—°ê²° 3ê°œ: "êµê³¼ ê°œë… â†’ ë„ì„œ ê°œë…" í˜•íƒœë¡œ ì”ë‹ˆë‹¤.
(4) ì¸ìš©/ì¶”ì  ìë£Œ: "ìë£Œëª… - í•„ìš”í•œ ì´ìœ "ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
(5) ì¶”ê°€ë¡œ ì ì„ ê²ƒ: ì§ˆë¬¸ 3ê°œë¥¼ ì”ë‹ˆë‹¤.
`.trim();
            break;

          case 4:
            prompt = `
[í•™ìˆ  íŠ¸ë Œë“œ/í‚¤ì›Œë“œ] ${sessionData.s4_keyword}
[í•µì‹¬ ìˆ«ì/íŒ©íŠ¸] ${sessionData.s4_fact}

ê·¼ê±° ì¤‘ì‹¬ ê°œì¡°ì‹ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
(1) í•µì‹¬ ì£¼ì¥: 1ë¬¸ì¥ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(2) ê·¼ê±° ë°ì´í„° 3ê°œ: "[ìˆ˜ì¹˜/ê²°ê³¼] - [ì¶œì²˜] - [ì˜ë¯¸]"ë¡œ ì”ë‹ˆë‹¤.
(3) í•´ì„ 3ì¤„: ì™œ ì¤‘ìš”í•œì§€/ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€ ì”ë‹ˆë‹¤.
(4) í•œê³„/ì£¼ì˜ì  2ê°œ: ì‹ ë¢°ë„/í‘œë³¸/ì¡°ê±´ ê´€ì ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(5) ë³´ê³ ì„œ ë¬¸ì¥ 3ê°œ: ì§§ê³  ëª…í™•í•˜ê²Œ ì”ë‹ˆë‹¤.
`.trim();
            break;

          case 5:
            prompt = `
[ìˆ˜í–‰/ë…¸ë ¥] ${sessionData.s5_log}
[ì‹œí–‰ì°©ì˜¤] ${sessionData.s5_error}
[ì¤‘ê°„ ì‚°ì¶œë¬¼] ${sessionData.s5_result}

ê³¼ì • ì¤‘ì‹¬ ê°œì¡°ì‹ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
(1) íƒ€ì„ë¼ì¸ 6ì¤„: "ë‚ ì§œ/í–‰ë™/ë„êµ¬"ë¡œ ì”ë‹ˆë‹¤.
(2) ì–´ë ¤ì›€ 3ê°œ: "ë¬¸ì œ-ì›ì¸-ëŒ€ì•ˆ"ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(3) ì¤‘ê°„ ê²°ê³¼ 3ê°œ: "ê²°ê³¼-ì˜ë¯¸-ë‹¤ìŒ í–‰ë™"ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(4) ì—­ëŸ‰ 5ê°œ: í‚¤ì›Œë“œ + ê·¼ê±° 1ì¤„ì”© ì”ë‹ˆë‹¤.
(5) ê°œì„ ì  3ê°œë¥¼ ì”ë‹ˆë‹¤.
`.trim();
            break;

          case 8:
            prompt = `
[ìµœì¢… ì£¼ì¥] ${sessionData.s8_claim}
[ì„±ì¥] ${sessionData.s8_growth}
[í›„ì† íƒêµ¬] ${sessionData.s8_next}
[ì„¸íŠ¹ ì´ˆì•ˆ] ${sessionData.s8_summary}

ì„¸íŠ¹ì— ë°”ë¡œ ì“°ê¸° ì¢‹ì€ ê°œì¡°ì‹ìœ¼ë¡œ ì •ë¦¬/ê°œì„ í•©ë‹ˆë‹¤.
(1) í•œ ì¤„ ìš”ì•½: ì£¼ì œ-ë°©ë²•-ê²°ë¡ ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(2) ê³¼ì • 5ì¤„: ë¬´ì—‡ì„ ì–´ë–»ê²Œ í–ˆëŠ”ì§€ ì”ë‹ˆë‹¤.
(3) ê·¼ê±°/ë°ì´í„° 3ì¤„ì„ ì”ë‹ˆë‹¤.
(4) ì„±ì¥ 3ì¤„: ì—­ëŸ‰/íƒœë„ ë³€í™” ì¤‘ì‹¬ìœ¼ë¡œ ì”ë‹ˆë‹¤.
(5) í›„ì† íƒêµ¬ 2ì¤„ì„ ì”ë‹ˆë‹¤.
(6) ìµœì¢… ì„¸íŠ¹ ë¬¸ì¥: 500ì ì´ë‚´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
`.trim();
            break;

          default:
            prompt = `
í˜„ì¬ íƒ­ì˜ ì…ë ¥ì„ ê°œì¡°ì‹ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
(1) í•µì‹¬ ìš”ì•½ 3ì¤„ì„ ì”ë‹ˆë‹¤.
(2) ì¢‹ì€ ì  2ì¤„ì„ ì”ë‹ˆë‹¤.
(3) ë³´ì™„ì  3ì¤„ì„ ì”ë‹ˆë‹¤.
(4) ë‹¤ìŒ í–‰ë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ 5ê°œë¥¼ ì”ë‹ˆë‹¤.
`.trim();
        }

        handleAskAI({ promptText: prompt, systemText: system });
      };

      const handleLogout = () => {
        setIsLoggedIn(false);
        setActiveUserKey("");
        setPersonalCode("");
        setStudentInfo({ ...EMPTY_STUDENT });
        setSessionData({ ...EMPTY_SESSION });
        setAiResult("");
        setServerStatus("");
      };

      const handleInput = (e) => setSessionData(prev => ({ ...prev, [e.target.name]: e.target.value }));
      const handleStudent = (e) => setStudentInfo(prev => ({ ...prev, [e.target.name]: e.target.value }));

      return (
        <div className="flex flex-col min-h-screen relative">
          {!isLoggedIn && (
            <LoginScreen
              personalCode={personalCode}
              setPersonalCode={setPersonalCode}
              handleLogin={handleLogin}
              serverStatus={serverStatus}
            />
          )}

          <div className="no-print flex-grow flex flex-col">
            <Header serverStatus={serverStatus} handleSaveAll={handleSaveAll} handleLogout={handleLogout} />
            <TabNavigation activeTab={activeTab} setActiveTab={setActiveTab} setAiResult={setAiResult} />

            <main className="flex-grow p-4 md:p-10 bg-slate-50">
              <div className="max-w-6xl mx-auto pb-32">
                <AiResultBox loading={aiLoading} result={aiResult} onClose={() => setAiResult("")} />
                <div className="bg-white rounded-[56px] border border-slate-200 shadow-sm p-8 md:p-16 min-h-[700px] flex flex-col">
                  <TabContent
                    activeTab={activeTab}
                    studentInfo={studentInfo}
                    sessionData={sessionData}
                    handleStudent={handleStudent}
                    handleInput={handleInput}
                    handleAiConsult={handleAiConsult}
                    aiLoading={aiLoading}
                  />
                </div>
              </div>
            </main>
          </div>

          <PrintView studentInfo={studentInfo} sessionData={sessionData} issueDate={issueDate} />
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
